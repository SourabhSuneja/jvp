<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>JVP Roll Number Assignment</title>
      <base href="https://myjvp.in/marks-management/">
      <!-- Supabase CRUD Functions -->
      <script type="module" src="supabase-crud.js"></script>
      <!-- Common JS Functions -->
      <script src="common.js"></script>
      <style>
         * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         max-height: 99999999px;
         }
         body {
         font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
         background: #f8fafc;
         min-height: 100vh;
         color: #334155;
         line-height: 1.6;
         }
         .container {
         max-width: 1200px;
         margin: 0 auto;
         background: white;
         min-height: 100vh;
         box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.05);
         }
         .header {
         background: #1e293b;
         color: white;
         padding: 2rem;
         border-bottom: 1px solid #e2e8f0;
         }
         .header h1 {
         font-size: 1.875rem;
         margin-bottom: 0.5rem;
         font-weight: 700;
         }
         .header p {
         font-size: 1rem;
         color: #94a3b8;
         font-weight: 400;
         }
         .main-content {
         padding: 2rem;
         }
         .instructions {
         background: #f1f5f9;
         border: 1px solid #e2e8f0;
         border-radius: 0.75rem;
         padding: 1.5rem;
         margin-bottom: 2rem;
         }
         .instructions h3 {
         color: #1e293b;
         margin-bottom: 0.75rem;
         font-size: 1.125rem;
         font-weight: 600;
         display: flex;
         align-items: center;
         gap: 0.5rem;
         }
         .instructions-icon {
         width: 20px;
         height: 20px;
         background: #3b82f6;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         color: white;
         font-size: 12px;
         font-weight: bold;
         }
         .instructions ul {
         list-style: none;
         margin-left: 0;
         }
         .instructions li {
         margin-bottom: 0.5rem;
         padding-left: 1.5rem;
         position: relative;
         color: #64748b;
         }
         .instructions li:before {
         content: "•";
         color: #3b82f6;
         font-weight: bold;
         position: absolute;
         left: 0;
         }
         .class-selector {
         background: white;
         border: 1px solid #e2e8f0;
         border-radius: 0.75rem;
         padding: 1.5rem;
         margin-bottom: 2rem;
         }
         .class-selector h2 {
         color: #1e293b;
         margin-bottom: 1rem;
         font-size: 1.25rem;
         font-weight: 600;
         }
         .select-wrapper {
         position: relative;
         display: inline-block;
         width: 100%;
         }
         .class-select {
         width: 100%;
         padding: 0.75rem 1rem;
         border: 1px solid #d1d5db;
         border-radius: 0.5rem;
         font-size: 1rem;
         background: white;
         cursor: pointer;
         transition: all 0.2s ease;
         }
         .class-select:focus {
         outline: none;
         border-color: #3b82f6;
         box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
         }
         .students-section {
         display: none;
         }
         .students-section.active {
         display: block;
         }
         .students-section h2 {
         color: #1e293b;
         margin-bottom: 1rem;
         font-size: 1.5rem;
         font-weight: 600;
         display: flex;
         align-items: center;
         gap: 0.75rem;
         }
         .class-badge {
         background: #3b82f6;
         color: white;
         padding: 0.25rem 0.75rem;
         border-radius: 9999px;
         font-size: 0.875rem;
         font-weight: 500;
         }
         .student-count {
         color: #64748b;
         margin-bottom: 1.5rem;
         font-size: 0.875rem;
         }
         .students-grid {
         margin-bottom: 2rem;
         position: relative;
         }
         .student-card {
         background: white;
         border: 1px solid #e2e8f0;
         border-radius: 0.5rem;
         padding: 1rem;
         margin-bottom: 0.75rem;
         transition: all 0.2s ease;
         display: flex;
         align-items: center;
         justify-content: space-between;
         position: relative;
         }
         .student-card:hover {
         border-color: #cbd5e1;
         box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
         }
         .student-card.moving {
         transform: translateY(-2px);
         box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
         border-color: #3b82f6;
         background: #f8fafc;
         }
         .student-info {
         display: flex;
         align-items: center;
         flex: 1;
         }
         .student-position {
         background: #1e293b;
         color: white;
         width: 2rem;
         height: 2rem;
         border-radius: 0.375rem;
         display: flex;
         align-items: center;
         justify-content: center;
         font-weight: 600;
         margin-right: 1rem;
         font-size: 0.875rem;
         }
         .student-card.moving .student-position {
         background: #3b82f6;
         }
         .student-name {
         font-size: 1rem;
         font-weight: 500;
         color: #1e293b;
         }
         .student-controls {
         display: flex;
         gap: 0.5rem;
         }
         .reorder-btn {
         width: 2rem;
         height: 2rem;
         border: 1px solid #d1d5db;
         border-radius: 0.375rem;
         cursor: pointer;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 12px;
         transition: all 0.2s ease;
         font-weight: 600;
         background: white;
         color: #64748b;
         }
         .reorder-btn:hover:not(:disabled) {
         border-color: #3b82f6;
         color: #3b82f6;
         background: #f8fafc;
         }
         .reorder-btn:active:not(:disabled) {
         transform: scale(0.95);
         }
         .reorder-btn:disabled {
         opacity: 0.4;
         cursor: not-allowed;
         }
         .btn-up:hover:not(:disabled) {
         border-color: #059669;
         color: #059669;
         background: #f0fdf4;
         }
         .btn-down:hover:not(:disabled) {
         border-color: #dc2626;
         color: #dc2626;
         background: #fef2f2;
         }
         .save-button {
         background: #3b82f6;
         color: white;
         border: none;
         padding: 0.75rem 2rem;
         font-size: 1rem;
         font-weight: 500;
         border-radius: 0.5rem;
         cursor: pointer;
         transition: all 0.2s ease;
         }
         .save-button:hover {
         background: #2563eb;
         }
         .save-button:active {
         transform: translateY(1px);
         }
         .save-button:disabled {
         background: #9ca3af;
         cursor: not-allowed;
         transform: none;
         }
         .save-section {
         text-align: center;
         margin-top: 2rem;
         padding: 1.5rem;
         background: #f8fafc;
         border-radius: 0.75rem;
         border: 1px solid #e2e8f0;
         }
         .save-section p {
         margin-top: 0.5rem;
         color: #64748b;
         font-size: 0.875rem;
         }
         .no-students {
         text-align: center;
         color: #64748b;
         font-size: 1rem;
         padding: 3rem 1rem;
         background: #f8fafc;
         border: 1px solid #e2e8f0;
         border-radius: 0.75rem;
         margin: 1rem 0;
         }
         .loading-overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 10000;
         opacity: 0;
         visibility: hidden;
         transition: all 0.2s ease;
         }
         .loading-overlay.active {
         opacity: 1;
         visibility: visible;
         }
         .loading-content {
         background: white;
         padding: 2rem;
         border-radius: 0.75rem;
         text-align: center;
         box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
         max-width: 20rem;
         width: 90%;
         }
         .spinner {
         width: 2rem;
         height: 2rem;
         border: 2px solid #e2e8f0;
         border-top: 2px solid #3b82f6;
         border-radius: 50%;
         animation: spin 1s linear infinite;
         margin: 0 auto 1rem;
         }
         @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
         }
         .loading-text {
         font-size: 1rem;
         font-weight: 500;
         color: #1e293b;
         margin-bottom: 0.5rem;
         }
         .loading-subtext {
         font-size: 0.875rem;
         color: #64748b;
         }
         /* Animation keyframes */
         @keyframes slideUp {
         from {
         transform: translateY(10px);
         opacity: 0.8;
         }
         to {
         transform: translateY(0);
         opacity: 1;
         }
         }
         @keyframes slideDown {
         from {
         transform: translateY(-10px);
         opacity: 0.8;
         }
         to {
         transform: translateY(0);
         opacity: 1;
         }
         }
         .student-card.slide-up {
         animation: slideUp 0.3s ease-out;
         }
         .student-card.slide-down {
         animation: slideDown 0.3s ease-out;
         }
         /* Responsive Design */
         @media (max-width: 768px) {
         .main-content {
         padding: 1rem;
         }
         .header {
         padding: 1.5rem 1rem;
         }
         .header h1 {
         font-size: 1.5rem;
         }
         .student-card {
         flex-direction: column;
         gap: 1rem;
         text-align: center;
         }
         .student-info {
         flex-direction: column;
         gap: 0.75rem;
         }
         .instructions {
         padding: 1rem;
         }
         }
      </style>
   </head>
   <body>
      <div class="container">
         <div class="header">
            <h1>Student Management System</h1>
            <p>Manage Student List Order</p>
         </div>
         <div class="main-content">
            <div class="instructions">
               <h3>
                  <span class="instructions-icon">i</span>
                  How to Reorder Students
               </h3>
               <ul>
                  <li>Use the up (▲) and down (▼) arrow buttons to move students in the list</li>
                  <li>The order you set here will be reflected in all marks statements</li>
                  <li>Click "Save Changes" to save your new order</li>
               </ul>
            </div>
            
            <div class="class-selector">
               <h2>Select Class</h2>
               <div class="select-wrapper">
                  <select id="classSelect" class="class-select">
                     <option value="">Choose a class...</option>
                  </select>
               </div>
            </div>
            <div id="studentsSection" class="students-section">
               <h2>
                  Students in Class
                  <span id="selectedClass" class="class-badge"></span>
               </h2>
               <div id="studentCount" class="student-count"></div>
               <div id="studentsGrid" class="students-grid"></div>
               <div id="noStudents" class="no-students" style="display: none;">
                  No students found in this class.
               </div>
               <div class="save-section">
                  <button id="saveButton" class="save-button" onclick="handleSave()">
                  Save Changes
                  </button>
                  <p>Save the new order to the system</p>
               </div>
            </div>
         </div>
      </div>
      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay">
         <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Processing...</div>
            <div class="loading-subtext">Please wait a moment.</div>
         </div>
      </div>
      <script>
         // Global data
         let students = [];
         
         let savedOrder = {};
         let currentClassStudents = [];
         let selectedClass = '';
         
         // Initialize the page
         function init() {
             populateClassSelect();
             setupEventListeners();
         }
         
         // Function to generate unique roll numbers
         function generateUniqueRollNumber(className, rollNumber) {
         // Map special sections
         const sectionMap = {
         "SCI": "A1",
         "COM": "A2",
         "HUM": "A3"
         };
         
         // Replace special section names with their mappings if needed
         for (const key in sectionMap) {
         if (className.includes(key)) {
             className = className.replace(key, sectionMap[key]);
         }
         }
         
         // Split class into number and section (e.g., "6" and "A2")
         const [classNum, section] = className.split("-");
         
         // Extract section number from "A2"
         const sectionNum = section.replace("A", "");
         
         // Pad roll number with leading zero if single digit
         const paddedRoll = rollNumber < 10 ? "0" + rollNumber : rollNumber.toString();
         
         // Return the concatenated unique roll number
         return `${classNum}${sectionNum}${paddedRoll}`;
         }
         
         // Populate the class select dropdown
         function populateClassSelect() {
             const classSelect = document.getElementById('classSelect');
             classes.forEach(cls => {
                 const option = document.createElement('option');
                 option.value = cls;
                 option.textContent = cls;
                 classSelect.appendChild(option);
             });
         }
         
         // Setup event listeners
         function setupEventListeners() {
             const classSelect = document.getElementById('classSelect');
             classSelect.addEventListener('change', handleClassChange);
         }
         
         // Handle class selection change
         async function handleClassChange(event) {
             selectedClass = event.target.value;
             loadingOverlay.classList.add('active');
             if (selectedClass) {
                 students = await selectData(
                      'students',
                      false,
                      'id, name, class',
                      ['class'],
                      [selectedClass],
                      'name',
                      'asc'
                  );
                 loadingOverlay.classList.remove('active');
                 loadStudentsForClass(selectedClass);
                 document.getElementById('studentsSection').classList.add('active');
                 document.getElementById('selectedClass').textContent = selectedClass;
             } else {
                 document.getElementById('studentsSection').classList.remove('active');
                 currentClassStudents = [];
             }
         }
         
         // Load students for selected class
         function loadStudentsForClass(className) {
             // Filter students by class
             let classStudents = students.filter(student => student.class === className);
             
             // Sort by roll_number if available, otherwise keep natural order
             if (classStudents.length > 0 && classStudents[0].hasOwnProperty('roll_number')) {
                 classStudents.sort((a, b) => a.roll_number - b.roll_number);
             }
             
             currentClassStudents = [...classStudents];
             displayStudents();
         }
         
         // Display students in the UI
         function displayStudents() {
             const studentsGrid = document.getElementById('studentsGrid');
             const studentCount = document.getElementById('studentCount');
             const noStudents = document.getElementById('noStudents');
             
             if (currentClassStudents.length === 0) {
                 studentsGrid.style.display = 'none';
                 noStudents.style.display = 'block';
                 studentCount.textContent = '';
                 return;
             }
             
             studentsGrid.style.display = 'block';
             noStudents.style.display = 'none';
             studentCount.textContent = `${currentClassStudents.length} students in this class`;
             
             studentsGrid.innerHTML = '';
             
             currentClassStudents.forEach((student, index) => {
                 const studentCard = createStudentCard(student, index);
                 studentsGrid.appendChild(studentCard);
             });
         }
         
         // Create a student card element
         function createStudentCard(student, index) {
             const card = document.createElement('div');
             card.className = 'student-card';
             card.dataset.studentId = student.id;
             
             card.innerHTML = `
                 <div class="student-info">
                     <div class="student-position">${index + 1}</div>
                     <div class="student-name">${student.name}</div>
                 </div>
                 <div class="student-controls">
                     <button class="reorder-btn btn-up" onclick="moveStudent(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>
                         ▲
                     </button>
                     <button class="reorder-btn btn-down" onclick="moveStudent(${index}, 'down')" ${index === currentClassStudents.length - 1 ? 'disabled' : ''}>
                         ▼
                     </button>
                 </div>
             `;
             
             return card;
         }
         
         // Move student up or down with animation
         function moveStudent(currentIndex, direction) {
             const cards = document.querySelectorAll('.student-card');
             const currentCard = cards[currentIndex];
             let targetIndex;
             
             if (direction === 'up' && currentIndex > 0) {
                 targetIndex = currentIndex - 1;
                 // Swap with previous student
                 [currentClassStudents[currentIndex], currentClassStudents[currentIndex - 1]] = 
                 [currentClassStudents[currentIndex - 1], currentClassStudents[currentIndex]];
             } else if (direction === 'down' && currentIndex < currentClassStudents.length - 1) {
                 targetIndex = currentIndex + 1;
                 // Swap with next student
                 [currentClassStudents[currentIndex], currentClassStudents[currentIndex + 1]] = 
                 [currentClassStudents[currentIndex + 1], currentClassStudents[currentIndex]];
             } else {
                 return; // No valid move
             }
         
             // Add animation classes
             const targetCard = cards[targetIndex];
             
             // Disable all buttons temporarily to prevent multiple clicks
             const allButtons = document.querySelectorAll('.reorder-btn');
             allButtons.forEach(btn => btn.disabled = true);
             
             // Add moving effect to both cards
             currentCard.classList.add('moving');
             targetCard.classList.add('moving');
             
             // Add slide animations
             if (direction === 'up') {
                 currentCard.classList.add('slide-up');
                 targetCard.classList.add('slide-down');
             } else {
                 currentCard.classList.add('slide-down');
                 targetCard.classList.add('slide-up');
             }
             
             // Remove animation classes and refresh display after animation
             setTimeout(() => {
                 // Clear all animation classes
                 const allCards = document.querySelectorAll('.student-card');
                 allCards.forEach(card => {
                     card.classList.remove('moving', 'slide-up', 'slide-down');
                 });
                 
                 // Refresh the display with new order
                 displayStudents();
                 
                 // Re-enable buttons
                 setTimeout(() => {
                     const newButtons = document.querySelectorAll('.reorder-btn');
                     newButtons.forEach(btn => {
                         if (!btn.hasAttribute('disabled') || btn.getAttribute('disabled') === 'false') {
                             btn.disabled = false;
                         }
                     });
                 }, 100);
             }, 300); // Match the animation duration
         }
         
         // Handle save button click
         async function handleSave() {
             if (!selectedClass || currentClassStudents.length === 0) {
                 return;
             }
             
             // Show loading overlay
             const loadingOverlay = document.getElementById('loadingOverlay');
             loadingOverlay.classList.add('active');
             
             // Simulate save operation with timeout
             setTimeout(async () => {
                 // Create the order object for this class
                 const classOrder = {};
                 currentClassStudents.forEach((student, index) => {
                     classOrder[student.id] = generateUniqueRollNumber(selectedClass, index + 1);
                 });
                 
                 // Update the global savedOrder
                 savedOrder[selectedClass] = classOrder;
         
                 // Sync changes to Supabase server
                 const result = await invokeFunction('update_student_roll_numbers', {
                  roll_data: savedOrder
              }, true);
              
              console.log('Result', result);
              if (!result) {
                  console.error('Function call failed entirely.');
                  alert('Update failed. Please try again or check function permissions.');
                  return false;
              }
                 
                 // Hide loading overlay
                 loadingOverlay.classList.remove('active');
                 
                 // Show success message (you can enhance this with a proper toast notification)
                 alert(`Successfully saved the order for class ${selectedClass}!`);
                 
                 // Log the saved order for debugging
                 console.log('Saved Order:', savedOrder);
                 
             }, 0); 
         }
         
         
          window.onload = async function() {
              try {
                  loadingOverlay.classList.add('active');
                  const isAuthenticated = await checkAuth();
                  if (!isAuthenticated) {
                       window.location = "https://myjvp.in/teachers/?ref=" + encodeURIComponent(window.location.href);
                  }
                  await filterClassesByClassTeachership();
                  init();
                  loadingOverlay.classList.remove('active');
              } catch (error) {
                  console.error('Error loading students:', error);
                  loadingOverlay.classList.remove('active');
              }
          };
         
         async function filterClassesByClassTeachership() {
         
                  // Bypass classteachership check if user is an admin
                  const adminId = await selectData(
                      'admins',
                      true,
                      'id',
                      ['id'],
                      [window.userId]
                  ); 
         
                  if(adminId) return;
         
                  const classesOwned = await selectData(
                      'class_teachers',
                      false,
                      'class',
                      ['teacher_id'],
                      [window.userId]
                  ); 
         
                  // Filter global classes array to keep only those classes for which the teacher holds classteachership
                 classes = classes.filter(c => classesOwned.some(o => o.class === c));
         }
      </script>
   </body>
</html>
