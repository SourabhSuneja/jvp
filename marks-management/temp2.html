<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <base href="https://myjvp.in/marks-management/">
      <title>Consolidated PT Marks Statement</title>
      <!-- Supabase CRUD Functions -->
      <script type="module" src="supabase-crud.js"></script>
      <!-- Common JS Functions -->
      <script src="common.js"></script>
      <style>
         :root {
         --primary: #4f46e5;
         --primary-dark: #4338ca;
         --secondary: #10b981;
         --secondary-dark: #059669;
         --danger: #ef4444;
         --danger-dark: #c33c3c;
         --light: #f9fafb;
         --dark: #1f2937;
         --text: #374151;
         --border: #e5e7eb;
         --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
         --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
         --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
         --transition: all 0.2s ease;
         }
         * {
         max-height: 9999999px;
         }
         body {
         font-family: Arial, sans-serif;
         margin: 0;
         padding: 20px;
         }
         .container {
         max-width: 1200px;
         margin: 0 auto;
         }
         .header {
         text-align: center;
         margin-bottom: 20px;
         text-transform: uppercase;
         }
         .school-name {
         font-size: 24px;
         font-weight: bold;
         margin-bottom: 5px;
         }
         .exam-session {
         font-size: 18px;
         margin-bottom: 3px;
         }
         .class-info {
         font-size: 16px;
         margin-bottom: 15px;
         }
         table {
         width: 100%;
         border-collapse: collapse;
         margin-bottom: 20px;
         }
         th, td {
         border: 1px solid #000;
         padding: 5px;
         text-align: center;
         font-size: 14px;
         }
         th {
         background-color: #f2f2f2;
         }
         .roll-col {
         width: 80px;
         }
         .name-col {
         width: 150px;
         text-align: left;
         }
         .mark-col {
         width: 40px;
         }
         .subject-header {
         position: relative;
         }
         .print-btn {
         padding: 10px 20px;
         background-color: #4CAF50;
         color: white;
         border: none;
         cursor: pointer;
         font-size: 16px;
         border-radius: 4px;
         }
         .print-btn:hover {
         background-color: #45a049;
         }
         @media print {
         .print-btn {
         display: none;
         }
         body {
         padding: 0;
         margin: 0;
         width: 100%;
         }
         .container {
         width: 100%;
         max-width: none;
         }
         table {
         /*page-break-inside: avoid;*/
         width: 100%;
         table-layout: fixed;
         font-size: 12px;
         }
         th, td {
         padding: 3px;
         font-size: 12px;
         }
         .roll-col {
         width: 6%;
         }
         .name-col {
         width: 15%;
         }
         .mark-col {
         width: 3%;
         }
         @page {
         size: A4 landscape;
         margin: 0.5cm;
         }
         }
         .loading-overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(255, 255, 255, 0.8);
         backdrop-filter: blur(4px);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 9999;
         }
         .spinner {
         width: 60px;
         height: 60px;
         border: 6px solid rgba(79, 70, 229, 0.3);
         border-radius: 50%;
         border-top-color: var(--primary);
         animation: spin 1s ease-in-out infinite;
         }
         @keyframes spin {
         to {
         transform: rotate(360deg);
         }
         }
         .hidden {
         display: none;
         }
         .highlight-rank {
         font-weight: bold;
         background-color: rgb(230, 230, 230);
         }
         @media print {
         .highlight-rank {
         font-weight: bold;
         background-color: rgb(230, 230, 230) !important;
         -webkit-print-color-adjust: exact; /* For Chrome, Safari */
         print-color-adjust: exact; /* Standard syntax */
         }
         }
         /* Custom Dialog Styles */
         .custom-dialog-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.15);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
         }
         .custom-dialog {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 24px;
            max-width: 94vw;
            min-width: 320px;
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
         }
         .custom-dialog h2 {
            font-size: 1.45rem;
            font-weight: bold;
            margin: 0 0 4px 0;
            color: var(--primary-dark);
            text-align: center;
         }
         .custom-dialog label {
            font-size: 1rem;
            margin-bottom: 6px;
            color: var(--text);
            font-weight: 500;
         }
         .custom-dialog select {
            width: 100%;
            padding: 9px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 1rem;
            margin-bottom: 8px;
            background: var(--light);
            transition: border-color 0.2s;
         }
         .custom-dialog select:focus {
            border-color: var(--primary);
            outline: none;
         }
         .custom-dialog .dialog-btn {
            padding: 10px 0;
            background: var(--primary);
            color: #fff;
            border-radius: 8px;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
         }
         .custom-dialog .dialog-btn:hover {
            background: var(--primary-dark);
         }
         @media (max-width: 550px) {
            .custom-dialog {
               width: 98vw;
               padding: 18px 10px;
            }
            .custom-dialog h2 {
               font-size: 1.1rem;
            }
         }
      </style>
   </head>
   <body>
      <!-- Loading Overlay -->
      <div id="loading-overlay" class="loading-overlay">
         <div class="spinner"></div>
      </div>
      <!-- Custom Dialog Overlay (hidden by default)-->
      <div id="custom-dialog-overlay" class="custom-dialog-overlay hidden">
         <form id="custom-dialog-form" class="custom-dialog" autocomplete="off">
            <h2>Select Class & Exam</h2>
            <div>
               <label for="class-select">Class</label>
               <select id="class-select" required>
                  <!-- Options populated dynamically -->
               </select>
            </div>
            <div>
               <label for="exam-select">Exam</label>
               <select id="exam-select" required>
                  <!-- Options populated dynamically -->
               </select>
            </div>
            <button type="submit" class="dialog-btn">Generate Marks Statement</button>
         </form>
      </div>
      <div class="container">
         <div class="header">
            <div class="school-name">Jamna Vidyapeeth</div>
            <div class="exam-session"><span id="exam-name"></span> (Session 2025-26)</div>
            <div class="class-info">Class: <span id="class-name"></span></div>
         </div>
         <table id="marks-table">
            <!-- Table will be dynamically generated -->
         </table>
         <div style="text-align: center;">
            <button class="print-btn" onclick="window.print()">Print Marks Statement</button>
         </div>
      </div>
      <script>
         // Global arrays
         let classes = ['1-A1', '1-A2', '1-A3', '2-A1', '2-A2', '2-A3', '3-A1', '3-A2', '3-A3', '3-A4', '4-A1', '4-A2', '4-A3', '4-A4', '5-A1', '5-A2', '5-A3', '5-A4', '6-A1', '6-A2', '6-A3', '6-A4', '7-A1', '7-A2', '7-A3', '7-A4', '8-A1', '8-A2', '8-A3', '9-A1', '9-A2', '9-A3', '10-A1', '10-A2', '10-A3', '11-SCI', '11-COM', '11-HUM', '12-SCI', '12-COM', '12-HUM'];
         let periodicExams = ['PT-1', 'PT-2', 'PT-3', 'PT-4'];

         // DOM elements
         const loadingOverlay = document.getElementById('loading-overlay');
         const customDialogOverlay = document.getElementById('custom-dialog-overlay');
         const classSelect = document.getElementById('class-select');
         const examSelect = document.getElementById('exam-select');
         const customDialogForm = document.getElementById('custom-dialog-form');

         // Marks data (will be loaded from server)
         let marks = [];
         
         let selectedSubjects = [];
         let selectedExam = '';
         let selectedClass = '';
         
         // Helper function to calculate ranks from an array of values
         function calculateRanks(values) {
            const indexedValues = values.map((value, index) => ({ value, index }));
            indexedValues.sort((a, b) => b.value - a.value);
            const ranks = new Array(values.length).fill(0);
            let currentRank = 1;
            for (let i = 0; i < indexedValues.length; i++) {
               if (i > 0 && indexedValues[i].value === indexedValues[i-1].value) {
                  ranks[indexedValues[i].index] = ranks[indexedValues[i-1].index];
               } else {
                  ranks[indexedValues[i].index] = currentRank;
               }
               if (i === indexedValues.length - 1 || indexedValues[i].value !== indexedValues[i+1].value) {
                  currentRank++;
               }
            }
            return ranks;
         }
         
         async function generateTable() {
            document.getElementById('exam-name').textContent = selectedExam;
            document.getElementById('class-name').textContent = selectedClass;

            selectedSubjects = selectedSubjects.filter(s => s !== 'All Subjects (Enthusiasm)');
            const filteredMarks = marks.filter(mark => 
               mark.exam === selectedExam && 
               mark.class === selectedClass && 
               selectedSubjects.includes(mark.subject) &&
               mark.subject !== 'All Subjects (Enthusiasm)'
            );
            const uniqueStudents = [...new Set(filteredMarks.map(mark => mark.student))].sort();
            const classNumber = selectedClass.split('-')[0];
            const sectionNumber = selectedClass.split('-')[1];
            const sectionDigit = sectionNumber.charAt(1);
            const table = document.getElementById('marks-table');
            table.innerHTML = '';
            const headerRow1 = document.createElement('tr');
            const headerRow2 = document.createElement('tr');
            const rollHeader = document.createElement('th');
            rollHeader.textContent = 'Roll No.';
            rollHeader.rowSpan = 2;
            rollHeader.classList.add('roll-col');
            headerRow1.appendChild(rollHeader);
            const nameHeader = document.createElement('th');
            nameHeader.textContent = 'Student Name';
            nameHeader.rowSpan = 2;
            nameHeader.classList.add('name-col');
            headerRow1.appendChild(nameHeader);
            selectedSubjects.forEach(subject => {
               const subjectHeader = document.createElement('th');
               subjectHeader.textContent = subject;
               subjectHeader.colSpan = 2;
               subjectHeader.classList.add('subject-header');
               headerRow1.appendChild(subjectHeader);
               const mark20Header = document.createElement('th');
               mark20Header.textContent = '20M';
               mark20Header.classList.add('mark-col');
               headerRow2.appendChild(mark20Header);
               const mark10Header = document.createElement('th');
               mark10Header.textContent = '10M';
               mark10Header.classList.add('mark-col');
               headerRow2.appendChild(mark10Header);
            });
            const totalHeader = document.createElement('th');
            totalHeader.textContent = 'Total';
            totalHeader.colSpan = 2;
            headerRow1.appendChild(totalHeader);
            const aggregateTotal20 = getAggregateMarks(selectedClass, selectedExam);
            const aggregateTotal10 = (getAggregateMarks(selectedClass, selectedExam))/2;
            const total20Header = document.createElement('th');
            total20Header.textContent = aggregateTotal20 + "M";
            headerRow2.appendChild(total20Header);
            const total10Header = document.createElement('th');
            total10Header.textContent = aggregateTotal10 + "M";
            headerRow2.appendChild(total10Header);
            const rankHeader = document.createElement('th');
            rankHeader.textContent = 'Rank';
            rankHeader.colSpan = 2;
            headerRow1.appendChild(rankHeader);
            const rank20Header = document.createElement('th');
            rank20Header.textContent = '20M';
            headerRow2.appendChild(rank20Header);
            const rank10Header = document.createElement('th');
            rank10Header.textContent = '10M';
            headerRow2.appendChild(rank10Header);
            table.appendChild(headerRow1);
            table.appendChild(headerRow2);
            const studentTotals20M = [];
            const studentTotals10M = [];
            const studentRows = [];
            uniqueStudents.forEach((student, idx) => {
               const row = document.createElement('tr');
               const serialNum = (idx + 1).toString().padStart(2, '0');
               const rollNo = `${classNumber}${sectionDigit}${serialNum}`;
               const rollCell = document.createElement('td');
               rollCell.textContent = rollNo;
               row.appendChild(rollCell);
               const nameCell = document.createElement('td');
               nameCell.textContent = student.toUpperCase();
               nameCell.style.textAlign = 'left';
               row.appendChild(nameCell);
               let total20M = 0;
               let total10M = 0;
               selectedSubjects.forEach(subject => {
                  const studentSubjectMark = filteredMarks.find(mark => 
                     mark.student === student && mark.subject === subject
                  );
                  const mark20Cell = document.createElement('td');
                  if (studentSubjectMark) {
                     if (studentSubjectMark.marks === null) {
                        mark20Cell.textContent = 'Ab';
                     } else {
                        const mark20 = Math.ceil(studentSubjectMark.marks);
                        mark20Cell.textContent = mark20;
                        total20M += mark20;
                     }
                  } else {
                     mark20Cell.textContent = '-';
                  }
                  row.appendChild(mark20Cell);
                  const mark10Cell = document.createElement('td');
                  if (studentSubjectMark) {
                     if (studentSubjectMark.marks === null) {
                        mark10Cell.textContent = 'Ab';
                     } else {
                        const mark10 = Math.ceil(studentSubjectMark.marks / 2);
                        mark10Cell.textContent = mark10;
                        total10M += mark10;
                     }
                  } else {
                     mark10Cell.textContent = '-';
                  }
                  row.appendChild(mark10Cell);
               });
               const total20Cell = document.createElement('td');
               total20Cell.textContent = total20M;
               row.appendChild(total20Cell);
               const total10Cell = document.createElement('td');
               total10Cell.textContent = total10M;
               row.appendChild(total10Cell);
               const rank20Cell = document.createElement('td');
               rank20Cell.classList.add('rank-20m-cell');
               row.appendChild(rank20Cell);
               const rank10Cell = document.createElement('td');
               rank10Cell.classList.add('rank-10m-cell');
               row.appendChild(rank10Cell);
               studentRows.push(row);
               studentTotals20M.push(total20M);
               studentTotals10M.push(total10M);
               table.appendChild(row);
            });
            const ranks20M = calculateRanks(studentTotals20M);
            const ranks10M = calculateRanks(studentTotals10M);
            studentRows.forEach((row, idx) => {
               const rank20Cell = row.querySelector('.rank-20m-cell');
               rank20Cell.textContent = ranks20M[idx];
               if(ranks20M[idx] === 1 || ranks20M[idx] === 2 || ranks20M[idx] === 3) {
                  rank20Cell.classList.add('highlight-rank');
               }
               const rank10Cell = row.querySelector('.rank-10m-cell');
               rank10Cell.textContent = ranks10M[idx];
               if(ranks10M[idx] === 1 || ranks10M[idx] === 2 || ranks10M[idx] === 3) {
                  rank10Cell.classList.add('highlight-rank');
               }
            });
         }
         
         // Show/hide loading overlay
         function showLoading() {
            loadingOverlay.classList.remove('hidden');
         }
         function hideLoading() {
            loadingOverlay.classList.add('hidden');
         }
         
         // Show Custom Dialog
         function showCustomDialog() {
            // Populate classSelect
            classSelect.innerHTML = '';
            classes.forEach(cls => {
               const opt = document.createElement('option');
               opt.value = cls;
               opt.textContent = cls;
               classSelect.appendChild(opt);
            });
            // Populate examSelect
            examSelect.innerHTML = '';
            periodicExams.forEach(exm => {
               const opt = document.createElement('option');
               opt.value = exm;
               opt.textContent = exm;
               examSelect.appendChild(opt);
            });
            customDialogOverlay.classList.remove('hidden');
         }
         function hideCustomDialog() {
            customDialogOverlay.classList.add('hidden');
         }

         // Load marks for selected class and exam
         async function loadMarks() {
            // Get the "class" parameter from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const classValue = urlParams.get("class");
            const exam = urlParams.get("exam");
            selectedExam = exam;
            selectedClass = classValue;
            selectedSubjects = getSubjectsForClass(selectedClass);
            // If class & exam are present and not falsy
            if (classValue && exam) {
               try {
                  const results = await selectData(
                     "marks_view", false, "*", ["class", "exam"], [classValue, exam], "student", "asc"
                  );
                  marks = results;
                  return true;
               } catch (error) {
                  console.error("Failed to load marks:", error);
                  return null;
               }
            } else {
               // Show custom dialog instead of redirect
               showCustomDialog();
               return false;
            }
         }

         // Listen for dialog form submit
         customDialogForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            selectedClass = classSelect.value;
            selectedExam = examSelect.value;
            selectedSubjects = getSubjectsForClass(selectedClass);
            hideCustomDialog();
            showLoading();
            // Simulate URL param availability for downstream code
            // (Do NOT update window.location)
            try {
               // Load marks
               const results = await selectData(
                  "marks_view", false, "*", ["class", "exam"], [selectedClass, selectedExam], "student", "asc"
               );
               marks = results;
               generateTable();
            } catch (err) {
               alert("Could not load marks for the selected class/exam.");
            } finally {
               hideLoading();
            }
         });

         // When window loads, check auth and load marks or show dialog
         window.addEventListener('load', async () => {
            showLoading();
            try {
               const isAuthenticated = await checkAuth();
               if (isAuthenticated) {
                  const loaded = await loadMarks();
                  if (loaded) {
                     generateTable();
                  }
                  hideLoading();
               } else {
                  window.location.href = "https://sourabhsuneja.github.io/redirect/jvp-marks-management/";
               }
            } catch (error) {
               console.error('Auth check error:', error);
            }
         });
      </script>
   </body>
</html>
