<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Annual Sports Meet - Participation</title>
      <!-- Supabase CRUD Functions -->
      <script type="module" src="https://myjvp.in/commons/supabase-crud.js"></script>
      <!-- Dialog Box Styles -->
      <link rel="stylesheet" href="https://myjvp.in/commons/dialog.css">
      <!-- Dialog Box Scripts -->
      <script src="https://myjvp.in/commons/dialog.js"></script>
      <style>
         /* --- Root Variables --- */
         :root {
         --primary-color: #007bff;
         --secondary-color: #6c757d;
         --bg-color: #f8f9fa;
         --card-bg: #ffffff;
         --text-color: #333;
         --border-color: #dee2e6;
         --success-color: #28a745;
         --danger-color: #dc3545;
         --disabled-color: #e9ecef;
         --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         }
         /* --- Basic Reset & Typography --- */
         body {
         font-family: var(--font-family);
         background-color: var(--bg-color);
         color: var(--text-color);
         margin: 0;
         padding: 20px;
         line-height: 1.6;
         }
         h1, h2, h3 {
         margin-top: 0;
         color: var(--primary-color);
         }
         h1 {
         text-align: center;
         margin-bottom: 30px;
         }
         /* --- Layout & Card --- */
         .container {
         max-width: 900px;
         margin: 0 auto;
         padding: 20px;
         background-color: var(--card-bg);
         border-radius: 8px;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
         }
         .card {
         background: #fff;
         border: 1px solid var(--border-color);
         border-radius: 8px;
         padding: 20px;
         margin-top: 20px;
         }
         /* --- Tabs --- */
         .tabs {
         display: flex;
         border-bottom: 2px solid var(--border-color);
         margin-bottom: 20px;
         }
         .tab-button {
         padding: 10px 20px;
         cursor: pointer;
         background: none;
         border: none;
         font-size: 16px;
         font-weight: 600;
         color: var(--secondary-color);
         border-bottom: 3px solid transparent;
         transition: all 0.3s ease;
         }
         .tab-button:hover {
         color: var(--primary-color);
         }
         .tab-button.active {
         color: var(--primary-color);
         border-bottom-color: var(--primary-color);
         }
         .tab-content {
         display: none;
         }
         .tab-content.active {
         display: block;
         }
         /* --- Form Elements --- */
         .form-group {
         margin-bottom: 20px;
         }
         .form-group label {
         display: block;
         font-weight: 600;
         margin-bottom: 8px;
         }
         select, button {
         width: 100%;
         padding: 12px;
         border: 1px solid var(--border-color);
         border-radius: 6px;
         font-size: 16px;
         background-color: #fff;
         transition: border-color 0.3s ease, box-shadow 0.3s ease;
         }
         select:focus, button:focus {
         outline: none;
         border-color: var(--primary-color);
         box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
         }
         button {
         background-color: var(--primary-color);
         color: white;
         font-weight: 600;
         cursor: pointer;
         }
         button:hover {
         opacity: 0.9;
         }
         button.btn-save {
         background-color: var(--success-color);
         margin-top: 20px;
         }
         button.btn-save:disabled {
         background-color: var(--secondary-color);
         cursor: not-allowed;
         }
         /* --- Lists (Students/Games) --- */
         .list-container {
         max-height: 300px;
         overflow-y: auto;
         border: 1px solid var(--border-color);
         border-radius: 6px;
         padding: 10px;
         background: #fdfdfd;
         }
         .list-container:empty::after {
         content: 'Please make a selection above.';
         display: block;
         text-align: center;
         color: var(--secondary-color);
         padding: 20px;
         }
         .list-item {
         display: block;
         padding: 10px;
         border-bottom: 1px solid #eee;
         cursor: pointer;
         transition: background-color 0.2s;
         }
         .list-item:last-child {
         border-bottom: none;
         }
         .list-item:hover {
         background-color: #f4f4f4;
         }
         .list-item input[type="radio"],
         .list-item input[type="checkbox"] {
         margin-right: 12px;
         transform: scale(1.1);
         }
         .list-item label {
         font-weight: 500;
         display: flex; /* Changed to flex for alignment */
         align-items: center;
         cursor: pointer;
         }
         .list-item span.details {
         font-size: 0.9em;
         color: var(--secondary-color);
         margin-left: auto; /* Pushes details to the right */
         padding-left: 10px;
         }
         .list-item input:disabled + span.name {
         color: var(--secondary-color);
         text-decoration: line-through;
         }
         .list-item input:disabled + span.name + span.details {
         color: var(--danger-color);
         text-decoration: none;
         }
         /* --- Utility & Responsive --- */
         .hidden {
         display: none;
         }
         #toast {
         position: fixed;
         bottom: 20px;
         left: 50%;
         transform: translateX(-50%);
         background-color: var(--success-color);
         color: white;
         padding: 16px 30px;
         border-radius: 8px;
         box-shadow: 0 4px 12px rgba(0,0,0,0.15);
         z-index: 1000;
         opacity: 0;
         transition: opacity 0.5s, transform 0.5s;
         visibility: hidden;
         }
         #toast.show {
         opacity: 1;
         visibility: visible;
         transform: translateX(-50%) translateY(0);
         }
         #toast.error {
         background-color: var(--danger-color);
         }
         .participant-group {
         border: 1px solid var(--border-color);
         border-radius: 8px;
         margin-bottom: 1rem;
         background: #fff;
         }
         .participant-group h4 {
         background-color: var(--border-color);
         padding: 0.5rem 0.75rem;
         margin: 0;
         border-radius: 8px 8px 0 0;
         }
         .participant-group .list-item {
         border-top: 1px solid var(--border-color);
         border-radius: 0;
         }
         .participant-group .details {
         padding-left: 1rem;
         }
         @media (max-width: 768px) {
         body {
         padding: 10px;
         }
         .container {
         padding: 15px;
         }
         .tabs {
         font-size: 14px;
         }
         .tab-button {
         padding: 10px 12px;
         }
         }
      </style>
   </head>
   <body class="light-theme">
      <div class="container">
         <h1>Annual Sports Meet - Participation Entry</h1>
         <div class="tabs">
            <button class="tab-button active" onclick="showTab('student-view')">Student-first Approach</button>
            <button class="tab-button" onclick="showTab('game-view')">Game-first Approach</button>
         </div>
         <div id="student-view" class="tab-content active">
            <div class="card">
               <h3>Step 1: Select a Class</h3>
               <div class="form-group">
                  <select id="student-class-select">
                     <option value="">-- Select a Class --</option>
                  </select>
               </div>
            </div>
            <div id="student-view-step-2" class="card hidden">
               <h3>Step 2: Select a Student</h3>
               <div id="student-list-container" class="list-container">
               </div>
            </div>
            <div id="student-view-step-3" class="card hidden">
               <h3>Step 3: Select Games for <span id="selected-student-name" style="color: var(--primary-color);"></span></h3>
               <p>A student can participate in at most <strong>one individual game</strong> and <strong>one team game</strong>.</p>
               <div id="student-games-container" class="list-container">
               </div>
               <button id="save-student-participation" class="btn-save">Save Participation</button>
            </div>
         </div>
         <div id="game-view" class="tab-content">
            <div class="card">
               <h3>Step 1: Select Game and House</h3>
               <div class="form-group">
                  <label for="game-event-select">Select a Game</label>
                  <select id="game-event-select">
                     <option value="">-- Select a Game --</option>
                  </select>
               </div>
               <div class="form-group">
                  <label for="game-house-select">Select a House</label>
                  <select id="game-house-select">
                     <option value="">-- Select a House --</option>
                     <option value="Ruby">Ruby</option>
                     <option value="Emerald">Emerald</option>
                     <option value="Sapphire">Sapphire</option>
                     <option value="Topaz">Topaz</option>
                  </select>
               </div>
            </div>
            <div id="game-view-step-2" class="card hidden">
               <h3>Step 2: Select Participants</h3>
               <h4 id="game-participant-counter" style="color: var(--secondary-color); text-align: center;"></h4>
               <div id="game-student-list-container" class="list-container">
               </div>
               <button id="save-game-participation" class="btn-save">Save Participants</button>
            </div>
         </div>
      </div>
      <div id="toast"></div>
      <!-- Dialog Overlay Starts -->
      <div id="dialog-overlay" class="dialog-overlay">
         <div class="dialog-box" id="dialog-box">
            <div class="dialog-header" id="dialog-header">Title</div>
            <div class="dialog-message" id="dialog-message">Message goes here</div>
            <div class="dialog-buttons" id="dialog-buttons">
               <!-- Buttons will be added dynamically -->
            </div>
         </div>
      </div>
      <!-- Dialog Overlay Ends -->
      <script>
         // ---=======================================---
         // ---         GLOBAL DATA (Sample)        ---
         // ---=======================================---
         
         const houses = ['Ruby', 'Emerald', 'Sapphire', 'Topaz'];
         
         const classes = ['1-A1', '1-A2', '1-A3', '2-A1', '2-A2', '2-A3', '3-A1', '3-A2', '3-A3', '3-A4', '4-A1', '4-A2', '4-A3', '4-A4', '5-A1', '5-A2', '5-A3', '5-A4', '6-A1', '6-A2', '6-A3', '6-A4', '7-A1', '7-A2', '7-A3', '7-A4', '8-A1', '8-A2', '8-A3', '9-A1', '9-A2', '9-A3', '10-A1', '10-A2', '11-SCI', '11-COM', '11-HUM', '12-SCI', '12-COM', '12-HUM'];
         
         let events = [];
         
         let students = [];
         
         // This is our "database"
         let participations = [];
         
         
         // ---=======================================---
         // ---         HELPER FUNCTIONS            ---
         // ---=======================================---
         
         // Function to sync participation changes with the backend
         async function syncParticipationChanges(changes) {
         if (changes.length === 0) {
            console.log("No participation changes detected.");
            return;
         }
         console.log(changes);
         try {
         const syncResult = await invokeFunction('manage_sport_participations', {
            changes_json: changes
         }, true);
         return syncResult || null;
         } catch (err) {
         console.error("Error updating participations:", err);
         return null;
         }
         }

         /**
 * Re-validates all game checkboxes in the student view based on UI state.
 * Disables/enables checkboxes based on student-level limits (1 team, 1 individual).
 */
function onStudentCheckboxChange() {
    const gameCheckboxes = studentGamesContainer.querySelectorAll('input[type="checkbox"]');
    if (gameCheckboxes.length === 0) return; // No checkboxes to check

    // 1. Get current counts from the UI
    let individualCount = 0;
    let teamCount = 0;
    gameCheckboxes.forEach(cb => {
        if (cb.checked) {
            const type = cb.dataset.type;
            if (type === 'Individual' || type === 'Grouped') individualCount++;
            if (type === 'Team') teamCount++;
        }
    });

    // 2. Loop and re-validate all checkboxes
    gameCheckboxes.forEach(cb => {
        const detailsEl = cb.closest('.list-item').querySelector('.details');
        // Get the base text (e.g., "9 to 12") that we stored in data-base-text
        const baseText = cb.dataset.baseText || detailsEl.textContent.replace(/\(.*\)/, '').trim();
        if (!cb.dataset.baseText) {
             cb.dataset.baseText = baseText; // Store it for next time
        }

        let disabledReason = "";
        let isDisabled = false;

        // Get the "hard" limits we stored
        const isGameFull = cb.dataset.gameFull === 'true';
        const isParticipating = cb.dataset.participating === 'true';

        // A user can always UN-check a box.
        // We only apply rules to boxes that are NOT checked.
        if (!cb.checked) { 
            // Check 1: Game Full (House-level, static)
            // This is a "hard" disable. If the team is full, student can't join.
            if (isGameFull && !isParticipating) { 
                isDisabled = true;
                disabledReason = `(Team completed)`;
            } else {
                // Check 2: Student-level limits (dynamic)
                const type = cb.dataset.type;
                const reachedIndividualLimit = (type === 'Individual' || type === 'Grouped') && individualCount >= 1;
                const reachedTeamLimit = type === 'Team' && teamCount >= 1;
                
                if (reachedIndividualLimit) {
                    isDisabled = true;
                    disabledReason = "(Already in an individual game)";
                } else if (reachedTeamLimit) {
                    isDisabled = true;
                    disabledReason = "(Already in a team game)";
                }
            }
        }
        
        cb.disabled = isDisabled;
        detailsEl.textContent = `${baseText} ${disabledReason}`.trim();
    });
}     

         /**
 * Re-validates checkboxes in the Game-First view for 'Team' and 'Individual' games.
 * Updates counters and disables boxes if a team limit is reached.
 */
function revalidateGameViewCheckboxes() {
    const selectedEventId = parseInt(gameEventSelect.value, 10);
    if (!selectedEventId) return;
    const event = getEventById(selectedEventId);

    const checkboxes = gameStudentListContainer.querySelectorAll('input[type="checkbox"]');
    let currentCount = 0;
    checkboxes.forEach(cb => {
        if (cb.checked) currentCount++;
    });

    // This validation only applies to 'Team' games
    if (event.game_type === 'Team') {
        const limit = event.group_size;
        
        // Update counter
        gameParticipantCounter.textContent = `(${currentCount} / ${limit} participants selected)`;

        const limitReached = currentCount >= limit;

        // Loop again to disable/enable
        checkboxes.forEach(cb => {
            const detailsEl = cb.closest('.list-item').querySelector('.details');
            const baseText = cb.dataset.baseText || detailsEl.textContent.replace(/\(.*\)/, '').trim();
            if (!cb.dataset.baseText) {
                cb.dataset.baseText = baseText; // Store it
            }

            // Check "hard" student limit we stored at render
            const studentLimit = cb.dataset.studentLimitReached === 'true';

            if (cb.checked) {
                cb.disabled = false; // Always allow unchecking
                if (!studentLimit) { // Don't clear reason if it's a student limit
                   detailsEl.textContent = baseText; 
                }
            } else {
                // This is an unchecked box. Disable it if EITHER limit is met.
                if (studentLimit) {
                    cb.disabled = true;
                    // The reason is already set from the render, so do nothing to text
                } else if (limitReached) {
                    cb.disabled = true;
                    detailsEl.textContent = `${baseText} (Team is full)`;
                } else {
                    cb.disabled = false;
                    detailsEl.textContent = baseText;
                }
            }
        });
    } else {
        // Just update counter for 'Individual'
        gameParticipantCounter.textContent = `(${currentCount} participants selected)`;
    }
}

/**
 * Re-validates the 'Grouped' game view, updating counters for each group.
 */
function revalidateGroupedGameView() {
    const selectedEventId = parseInt(gameEventSelect.value, 10);
    if (!selectedEventId) return;
    const event = getEventById(selectedEventId);
    const groupSize = event.group_size;

    let totalGroups = 0;

    // 1. Update existing groups
    const groupContainers = gameStudentListContainer.querySelectorAll('.participant-group[data-group-id]:not([data-group-id="new"])');
    groupContainers.forEach(container => {
        totalGroups++;
        const members = container.querySelectorAll('input[type="checkbox"]:checked').length;
        const header = container.querySelector('h4');
        let status = members === groupSize ? '(Full)' : `(Incomplete: ${members} / ${groupSize})`;
        
        // Update header text, preserving group number
        let headerText = header.dataset.baseText;
        if (!headerText) {
            headerText = header.textContent.replace(/\(.*\)/, '').trim();
            header.dataset.baseText = headerText;
        }
        header.textContent = `${headerText} ${status}`;
    });
    
    // 2. Update "new" group
    const newContainer = gameStudentListContainer.querySelector('.participant-group[data-group-id="new"]');
    if (newContainer) {
        const newMembersCount = newContainer.querySelectorAll('input[type="checkbox"]:checked').length;
        const newHeader = newContainer.querySelector('h4');
        newHeader.textContent = `Available Students (${newMembersCount} selected to form new groups)`;
    }
    
    // Update main counter
    gameParticipantCounter.textContent = `(${totalGroups} groups formed. Each group needs ${groupSize} members.)`;
}
         /** Generates a UUID for linking participants in a group/team together */
         function generateUUID() {
         const bytes = crypto.getRandomValues(new Uint8Array(16));
         
         // Per RFC 4122 section 4.4
         bytes[6] = (bytes[6] & 0x0f) | 0x40; // Version 4
         bytes[8] = (bytes[8] & 0x3f) | 0x80; // Variant 10
         
         const hex = Array.from(bytes, b => b.toString(16).padStart(2, '0'));
         
         return (
         hex.slice(0, 4).join('') + '-' +
         hex.slice(4, 6).join('') + '-' +
         hex.slice(6, 8).join('') + '-' +
         hex.slice(8, 10).join('') + '-' +
         hex.slice(10, 16).join('')
         );
         }
         
         /** Gets the numeric part of a class string, e.g., "7-A1" -> 7, "11-SCI" -> 11 */
         function getNumericClass(classString) {
             return parseInt(classString.split('-')[0].split('.')[0], 10);
         }
         
         /** Finds a student object by their ID */
         function getStudentById(studentId) {
             return students.find(s => s.id === studentId);
         }
         
         /** Finds an event object by its ID */
         function getEventById(eventId) {
             return events.find(e => e.id === eventId);
         }
         
         /**
          * Checks if a student's class matches a game's class category.
          * @param {number} studentClass - e.g., 7
          * @param {string} gameCategory - e.g., "7" or "7 to 10"
          */
         function checkClassCategory(studentClass, gameCategory) {
             if (gameCategory.includes(' to ')) {
                 const [min, max] = gameCategory.split(' to ').map(Number);
                 return studentClass >= min && studentClass <= max;
             } else {
                 return studentClass === parseInt(gameCategory, 10);
             }
         }
         
         /**
          * Checks if a student's gender matches a game's gender filter.
          * @param {string} studentGender - "M" or "F"
          * @param {string} gameGenderFilter - "Boys", "Girls", or "Mixed"
          */
         function checkGender(studentGender, gameGenderFilter) {
             if (gameGenderFilter === "Mixed") return true;
             if (gameGenderFilter === "Boys" && studentGender === "M") return true;
             if (gameGenderFilter === "Girls" && studentGender === "F") return true;
             return false;
         }
         
         /** Gets all participations for a specific student */
         function getParticipationsByStudent(studentId) {
             return participations.filter(p => p.student_id === studentId);
         }
         
         /** Gets all participations for a specific event AND house */
         function getParticipationsByEventAndHouse(eventId, house) {
             return participations.filter(p => {
                 const student = getStudentById(p.student_id);
                 return p.event_id === eventId && student && student.house === house;
             });
         }
         
         /** Shows a toast notification */
         function showToast(message, isError = false) {
             const toast = document.getElementById('toast');
             toast.textContent = message;
             toast.className = 'show' + (isError ? ' error' : '');
             setTimeout(() => {
                 toast.className = toast.className.replace('show', '');
             }, 3000);
         }
         
         // ---=======================================---
         // ---         TAB SWITCHING LOGIC         ---
         // ---=======================================---
         
         function showTab(tabId) {
             document.querySelectorAll('.tab-content').forEach(content => {
                 content.classList.remove('active');
             });
             document.querySelectorAll('.tab-button').forEach(button => {
                 button.classList.remove('active');
             });
         
             document.getElementById(tabId).classList.add('active');
             document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
         }
         
         
         // ---=======================================---
         // ---      STUDENT-FIRST VIEW LOGIC       ---
         // ---=======================================---
         
         const studentClassSelect = document.getElementById('student-class-select');
         const studentListContainer = document.getElementById('student-list-container');
         const studentViewStep2 = document.getElementById('student-view-step-2');
         const studentViewStep3 = document.getElementById('student-view-step-3');
         const studentGamesContainer = document.getElementById('student-games-container');
         const selectedStudentNameEl = document.getElementById('selected-student-name');
         const saveStudentButton = document.getElementById('save-student-participation');
         
         function initStudentView() {
             // 1. Populate class dropdown
             studentClassSelect.innerHTML = '<option value="">-- Select a Class --</option>'; // Reset
             classes.forEach(cls => {
                 studentClassSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
             });
         
             // 2. Add event listener
             studentClassSelect.addEventListener('change', onStudentClassSelect);
             saveStudentButton.addEventListener('click', onSaveStudentParticipation);
         }
         
         function onStudentClassSelect() {
             const selectedClass = studentClassSelect.value;
             studentListContainer.innerHTML = ""; // Clear list
             studentGamesContainer.innerHTML = ""; // Clear games
             studentViewStep3.classList.add('hidden'); // Hide step 3
             
             if (!selectedClass) {
                 studentViewStep2.classList.add('hidden');
                 return;
             }
         
             const studentsInClass = students.filter(s => s.class === selectedClass);
             
             if (studentsInClass.length === 0) {
                  studentListContainer.innerHTML = '<p style="text-align:center; color: var(--secondary-color);">No students found in this class.</p>';
             } else {
                 studentsInClass.forEach(student => {
                     studentListContainer.innerHTML += `
                         <label class="list-item">
                             <input type="radio" name="student" value="${student.id}">
                             <span class="name">${student.name}</span>
                             <span class="details">${student.house}</span>
                         </label>
                     `;
                 });
             }
             
             studentViewStep2.classList.remove('hidden');
         
             // Add event listeners to new radio buttons
             document.querySelectorAll('input[name="student"]').forEach(radio => {
                 radio.addEventListener('change', onStudentSelect);
             });
         }
         
         function onStudentSelect() {
             const selectedStudentId = document.querySelector('input[name="student"]:checked').value;
             const student = getStudentById(selectedStudentId);
             
             if (!student) return;
         
             selectedStudentNameEl.textContent = student.name;
             studentGamesContainer.innerHTML = ""; // Clear old list
             
             const studentNumClass = getNumericClass(student.class);
             const myParticipations = getParticipationsByStudent(student.id);
         
             // Get counts of games student is already in
             let individualCount = 0;
             let teamCount = 0;
             myParticipations.forEach(p => {
                 const event = getEventById(p.event_id);
                 if (!event) return; // Safety check
                 if (event.game_type === 'Individual' || event.game_type === 'Grouped') individualCount++;
                 if (event.game_type === 'Team') teamCount++;
             });
         
             // Find all eligible games
             const eligibleGames = events.filter(event => 
                 checkClassCategory(studentNumClass, event.class_category) &&
                 checkGender(student.gender, event.gender_filter)
             );
         
             if (eligibleGames.length === 0) {
                 studentGamesContainer.innerHTML = '<p style="text-align:center; color: var(--secondary-color);">No eligible games found for this student.</p>';
             } else {
            eligibleGames.forEach(event => {
                const isParticipating = myParticipations.some(p => p.event_id === event.id);
                
                // Check house-level participant limit
                const eventParticipations = getParticipationsByEventAndHouse(event.id, student.house);
    
                // Limit logic
                let isGameFull = false;
                if (event.game_type === 'Team') {
                isGameFull = eventParticipations.length >= event.group_size; // Use group_size
                }
                
                // Check student-level game type limit
                const reachedIndividualLimit = (event.game_type === 'Individual' || event.game_type === 'Grouped') && individualCount >= 1;
                const reachedTeamLimit = event.game_type === 'Team' && teamCount >= 1;
    
                let isDisabled = false;
                let disabledReason = "";
    
                if (!isParticipating) {
                    if (isGameFull) {
                        isDisabled = true;
                        disabledReason = `(Team completed for ${student.house})`;
                    } else if (reachedIndividualLimit) {
                        isDisabled = true;
                        disabledReason = "(Already in an individual game)";
                    } else if (reachedTeamLimit) {
                        isDisabled = true;
                        disabledReason = "(Already in a team game)";
                    }
                }
        
                studentGamesContainer.innerHTML += `
                    <label class="list-item">
                        <input type="checkbox" value="${event.id}" data-type="${event.game_type}" 
                            data-participating="${isParticipating}"
                            data-game-full="${isGameFull}"
                            ${isParticipating ? 'checked' : ''} 
                            ${isDisabled ? 'disabled' : ''}>
                        <span class="name">${event.game_name} (${event.game_type})</span>
                        <span class="details" data-base-text="${event.class_category}">${event.class_category} ${disabledReason}</span>
                    </label>
                `;
            });
        }
        
        // Add change listeners to all new checkboxes
        studentGamesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', onStudentCheckboxChange);
        });

        studentViewStep3.classList.remove('hidden');
    }
         
         async function onSaveStudentParticipation() {
    const selectedStudentId = document.querySelector('input[name="student"]:checked')?.value;
    if (!selectedStudentId) {
        showToast("Please select a student first.", true);
        return;
    }

    const student = getStudentById(selectedStudentId);
    const gameCheckboxes = studentGamesContainer.querySelectorAll('input[type="checkbox"]');

    const changes = []; // To track participation changes

    const desiredEventIds = new Set();
    gameCheckboxes.forEach(cb => {
        if (cb.checked) {
            desiredEventIds.add(parseInt(cb.value, 10));
        }
    });

    const currentEventIds = new Set(getParticipationsByStudent(student.id).map(p => p.event_id));

    // 1. Calculate new participations to add
    desiredEventIds.forEach(eventId => {
        if (!currentEventIds.has(eventId)) {
            // Student wants to join this game, and isn't already in it
            const event = getEventById(eventId);

            // Find an existing group ID for this event/house, or create one
            let groupId;
            if (event.game_type === 'Individual') {
                // Each student is their own group
                groupId = generateUUID();
            } else if (event.game_type === 'Team') {
                // All students from one house share ONE group ID
                const existingGroup = participations.find(p => {
                    const pStudent = getStudentById(p.student_id);
                    return p.event_id === eventId && pStudent && pStudent.house === student.house;
                });
                groupId = existingGroup ? existingGroup.participant_group_id : generateUUID();
            } else if (event.game_type === 'Grouped') {
                // From this view, we just add the student.
                // The "Game-First" view will be used to organize them into a pair/group.
                // So, we give them their own unique (temporary) group ID.
                groupId = generateUUID();
            }

            // --- MODIFICATION: Do NOT push to participations yet ---

            // Add to the changes array
            changes.push({
                change: "add",
                student_id: student.id,
                event_id: eventId,
                participant_group_id: groupId
            });

        }
    });

    // 2. Calculate old participations to remove
    currentEventIds.forEach(eventId => {
        if (!desiredEventIds.has(eventId)) {
            // Student was in this game, but is no longer

            // Find the participation record before filtering to get the group ID
            const participationToRemove = participations.find(p =>
                p.student_id === student.id && p.event_id === eventId
            );

            // Add removal changes to the changes array
            if (participationToRemove) {
                changes.push({
                    change: "remove",
                    student_id: student.id,
                    event_id: eventId,
                    participant_group_id: participationToRemove.participant_group_id
                });
            }

            // --- MODIFICATION: Do NOT filter participations yet ---
        }
    });

    // Only proceed if there are actual changes
    if (changes.length === 0) {
        onStudentSelect(); // Refresh view anyway, just in case
        return;
    }

    showProcessingDialog();
    const updated = await syncParticipationChanges(changes);
    hideProcessingDialog();

    if (updated) {
        // --- NEW: Apply changes locally *only* on success ---
        changes.forEach(change => {
            if (change.change === "add") {
                participations.push({
                    student_id: change.student_id,
                    event_id: change.event_id,
                    participant_group_id: change.participant_group_id
                });
            } else if (change.change === "remove") {
                participations = participations.filter(p =>
                    !(p.student_id === change.student_id && p.event_id === change.event_id)
                );
            }
        });
        // --- End of new logic ---

        await showDialog({
            title: 'Success',
            message: 'Participation updated: Added ' + updated.added + ' students. Removed: ' + updated.removed + ' students.',
            type: 'alert'
        });
    } else {
        await showDialog({
            title: 'Error',
            message: 'Error updating participation. You may be trying to change participation for the students you are not authorized to. Some students may not be in the class/house you manage.',
            type: 'alert'
        });
    }

    // 3. Refresh the view to show updated limits
    onStudentSelect();
}
         
         // ---=======================================---
         // ---        GAME-FIRST VIEW LOGIC        ---
         // ---=======================================---
         
         const gameEventSelect = document.getElementById('game-event-select');
         const gameHouseSelect = document.getElementById('game-house-select');
         const gameViewStep2 = document.getElementById('game-view-step-2');
         const gameStudentListContainer = document.getElementById('game-student-list-container');
         const gameParticipantCounter = document.getElementById('game-participant-counter');
         const saveGameButton = document.getElementById('save-game-participation');
         
         function initGameView() {
             // 1. Populate game dropdown
             gameEventSelect.innerHTML = '<option value="">-- Select a Game --</option>'; // Reset
             events.forEach(event => {
                 gameEventSelect.innerHTML += `
                     <option value="${event.id}">
                         ${event.game_name} (${event.class_category}, ${event.gender_filter})
                     </option>
                 `;
             });
             
             // 2. Add event listeners
             gameEventSelect.addEventListener('change', onGameOrHouseSelect);
             gameHouseSelect.addEventListener('change', onGameOrHouseSelect);
             saveGameButton.addEventListener('click', onSaveGameParticipation);
         }
         
         function onGameOrHouseSelect() {
         const selectedEventId = parseInt(gameEventSelect.value, 10);
         const selectedHouse = gameHouseSelect.value;
         
         gameStudentListContainer.innerHTML = ""; // Clear
         
         if (!selectedEventId || !selectedHouse) {
         gameViewStep2.classList.add('hidden');
         return;
         }
         
         const event = getEventById(selectedEventId);
         
         // --- Main Logic Branch Based on Game Type ---
         
         if (event.game_type === 'Team' || event.game_type === 'Individual') {
         // --- LOGIC FOR 'Team' and 'Individual' ---
         
         const eventParticipations = getParticipationsByEventAndHouse(event.id, selectedHouse);
         const currentCount = eventParticipations.length;
         
         // Handle 'Individual' games (where group_size=1) vs 'Team' games
         const limitApplies = event.game_type === 'Team';
         const displayMaxCount = limitApplies ? event.group_size : 'N/A';
         
         // Update counter text based on game type
         if (event.game_type === 'Team') {
             gameParticipantCounter.textContent = `(${currentCount} / ${displayMaxCount} participants selected)`;
         } else { // 'Individual'
             gameParticipantCounter.textContent = `(${currentCount} participants selected)`;
         }
         
         // Find all eligible students
         const eligibleStudents = students.filter(student => 
             student.house === selectedHouse &&
             checkGender(student.gender, event.gender_filter) &&
             checkClassCategory(getNumericClass(student.class), event.class_category)
         );
         
         if (eligibleStudents.length === 0) {
             gameStudentListContainer.innerHTML = '<p style="text-align:center; color: var(--secondary-color);">No eligible students found for this house and game.</p>';
         } else {
             eligibleStudents.forEach(student => {
                 const isParticipating = eventParticipations.some(p => p.student_id === student.id);
                 
                 // --- Get student's personal limits FOR OTHER GAMES ---
         // We check what other games the student is in, *excluding* this one.
         const myOtherParticipations = getParticipationsByStudent(student.id).filter(p => p.event_id !== event.id);
         let studentIndividualCount = 0;
         let studentTeamCount = 0;
         myOtherParticipations.forEach(p => {
             const pEvent = getEventById(p.event_id);
             if (!pEvent) return;
             if (pEvent.game_type === 'Individual' || pEvent.game_type === 'Grouped') studentIndividualCount++;
             if (pEvent.game_type === 'Team') studentTeamCount++;
         });

         // Get the type of the game we are CURRENTLY viewing
         const currentEventType = event.game_type;

         // Check if game is full (only applies to 'Team')
         const isGameFull = limitApplies && currentCount >= event.group_size;
         
         let isDisabled = false;
         let disabledReason = "";
         let studentLimitReached = false; // This is the new "lock"

         // Apply rules only if the student is NOT already in this game.
         if (!isParticipating) { 
             // Rule 1: Game-level limit (Team Full)
             if (isGameFull) {
                 isDisabled = true;
                 disabledReason = "(Team is full)";
             } else {
                 // Rule 2: Student-level limits
                 const reachedIndividualLimit = (currentEventType === 'Individual' || currentEventType === 'Grouped') && studentIndividualCount >= 1;
                 const reachedTeamLimit = currentEventType === 'Team' && studentTeamCount >= 1;

                 if (reachedIndividualLimit) {
                     isDisabled = true;
                     studentLimitReached = true; // Set the lock
                     disabledReason = "(Already in an individual game)";
                 } else if (reachedTeamLimit) {
                     isDisabled = true;
                     studentLimitReached = true; // Set the lock
                     disabledReason = "(Already in a team game)";
                 }
             }
         }
         
                 gameStudentListContainer.innerHTML += `
                    <label class="list-item">
                        <input type="checkbox" value="${student.id}" 
                            data-type="${currentEventType}"
                            data-student-limit-reached="${studentLimitReached}"
                            ${isParticipating ? 'checked' : ''}
                            ${isDisabled ? 'disabled' : ''}>
                        <span class="name">${student.name}</span>
                        <span class="details" data-base-text="${student.class}">${student.class} ${disabledReason}</span>
                    </label>
                `;
             });
            gameStudentListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', revalidateGameViewCheckboxes);
            });
         }
         
         } else if (event.game_type === 'Grouped') {
         // --- NEW LOGIC FOR 'Grouped' ---
         // Render UI for "Group 1", "Group 2", ... "Available Students"
         
         const eventParticipations = getParticipationsByEventAndHouse(event.id, selectedHouse);
         const groupSize = event.group_size;
         
         // 1. Group existing participants by their group_id
         const groups = {}; // Key: group_id, Value: array of student objects
         eventParticipations.forEach(p => {
             const student = getStudentById(p.student_id);
             if (!student) return;
             
             if (!groups[p.participant_group_id]) {
                 groups[p.participant_group_id] = [];
             }
             groups[p.participant_group_id].push(student);
         });
         
         // 2. Find unassigned students
         const assignedStudentIds = new Set(eventParticipations.map(p => p.student_id));
         const eligibleStudents = students.filter(student => 
             student.house === selectedHouse &&
             checkGender(student.gender, event.gender_filter) &&
             checkClassCategory(getNumericClass(student.class), event.class_category)
         );
         const unassignedStudents = eligibleStudents.filter(s => !assignedStudentIds.has(s.id));
         
         // 3. Render existing groups
         let groupCounter = 1;
         for (const groupId in groups) {
             const members = groups[groupId];
             let groupHTML = `<div class="participant-group" data-group-id="${groupId}">`;
             
             // Check if group is full or incomplete
             let status = members.length === groupSize ? '(Full)' : `(Incomplete: ${members.length} / ${groupSize})`;
             groupHTML += `<h4>Group ${groupCounter} ${status}</h4>`;
             
             members.forEach(student => {
                 groupHTML += `
                     <label class="list-item">
                         <input type="checkbox" value="${student.id}" checked>
                         <span class="name">${student.name}</span>
                         <span class="details">${student.class}</span>
                     </label>
                 `;
             });
             groupHTML += `</div>`;
             gameStudentListContainer.innerHTML += groupHTML;
             groupCounter++;
         }
         
         // 4. Render unassigned students
         let unassignedHTML = `<div class="participant-group" data-group-id="new">`;
         unassignedHTML += `<h4>Available Students (to form new groups)</h4>`;
         if (unassignedStudents.length === 0) {
             unassignedHTML += `<p class="details" style="padding: 0.75rem;">No more eligible students available.</p>`;
         }
         unassignedStudents.forEach(student => {
             // --- Get student's personal limits FOR OTHER GAMES ---
             const myOtherParticipations = getParticipationsByStudent(student.id).filter(p => p.event_id !== event.id);
             let studentIndividualCount = 0;
             myOtherParticipations.forEach(p => {
                 const pEvent = getEventById(p.event_id);
                 if (!pEvent) return;
                 if (pEvent.game_type === 'Individual' || pEvent.game_type === 'Grouped') studentIndividualCount++;
             });

             const currentEventType = event.game_type; // 'Grouped'
             let isDisabled = false;
             let disabledReason = "";
             let studentLimitReached = false; // The lock

             // Rule: Student-level limits (Grouped counts as Individual)
             if (studentIndividualCount >= 1) {
                 isDisabled = true;
                 studentLimitReached = true;
                 disabledReason = "(Already in an individual game)";
             }

             unassignedHTML += `
                 <label class="list-item">
                     <input type="checkbox" value="${student.id}" 
                            data-type="${currentEventType}"
                            data-student-limit-reached="${studentLimitReached}"
                            ${isDisabled ? 'disabled' : ''}>
                     <span class="name">${student.name}</span>
                     <span class="details" data-base-text="${student.class}">${student.class} ${disabledReason}</span>
                 </label>
             `;
         });
         unassignedHTML += `</div>`;
         gameStudentListContainer.innerHTML += unassignedHTML;
         
         gameParticipantCounter.textContent = `(${groupCounter-1} groups formed. Each group needs ${groupSize} members.)`;

         gameStudentListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', revalidateGroupedGameView);
        });
         }
         
         gameViewStep2.classList.remove('hidden');
         }
         
         async function onSaveGameParticipation() {
    const selectedEventId = parseInt(gameEventSelect.value, 10);
    const selectedHouse = gameHouseSelect.value;

    if (!selectedEventId || !selectedHouse) {
        showToast("Please select both a game and a house.", true);
        return;
    }

    const event = getEventById(selectedEventId);
    const changes = []; // To track participation changes

    // --- Main Logic Branch based on game type ---

    if (event.game_type === 'Team' || event.game_type === 'Individual') {
        // --- Original logic with tweaks for Team/Individual ---
        const studentCheckboxes = gameStudentListContainer.querySelectorAll('input[type="checkbox"]');

        // Find or create the group ID for this Team/pair
        const existingGroup = participations.find(p => {
            const pStudent = getStudentById(p.student_id);
            return p.event_id === selectedEventId && pStudent && pStudent.house === selectedHouse;
        });
        const groupId = existingGroup ? existingGroup.participant_group_id : generateUUID();

        const desiredStudentIds = new Set();
        studentCheckboxes.forEach(cb => {
            if (cb.checked) {
                desiredStudentIds.add(cb.value);
            }
        });

        const currentStudentIds = new Set(
            getParticipationsByEventAndHouse(selectedEventId, selectedHouse).map(p => p.student_id)
        );

        // let addedCount = 0; // No longer needed
        // let removedCount = 0; // No longer needed
        let errors = [];

        // 1. Calculate new participants to add
        desiredStudentIds.forEach(studentId => {
            if (!currentStudentIds.has(studentId)) {
                // Check max participant limit *again* before adding
                const currentTotal = getParticipationsByEventAndHouse(selectedEventId, selectedHouse).length;

                // UPDATED: Only check limit for 'Team' type
                if (event.game_type === 'Team' && currentTotal >= event.group_size) {
                    errors.push(`Could not add ${getStudentById(studentId).name}: Team is full.`);
                } else {
                    // --- MODIFICATION: Do NOT push to participations yet ---

                    // Save participant additions in the changes array
                    changes.push({
                        change: "add",
                        student_id: studentId,
                        event_id: selectedEventId,
                        participant_group_id: groupId
                    });

                    // addedCount++; // No longer needed
                }
            }
        });

        // 2. Calculate old participants to remove
        currentStudentIds.forEach(studentId => {
            if (!desiredStudentIds.has(studentId)) {
                // Add removals to the changes array
                changes.push({
                    change: "remove",
                    student_id: studentId,
                    event_id: selectedEventId,
                    participant_group_id: groupId // All students in this view share the same group ID
                });

                // --- MODIFICATION: Do NOT filter participations yet ---
                // removedCount++; // No longer needed
            }
        });
        
        // Only proceed if there are actual changes
        if (changes.length === 0 && errors.length === 0) {
             onGameOrHouseSelect(); // Refresh
             return;
        }

        showProcessingDialog();
        const updated = await syncParticipationChanges(changes);
        hideProcessingDialog();

        if (updated) {
            // --- NEW: Apply changes locally *only* on success ---
            changes.forEach(change => {
                if (change.change === "add") {
                    participations.push({
                        student_id: change.student_id,
                        event_id: change.event_id,
                        participant_group_id: change.participant_group_id
                    });
                } else if (change.change === "remove") {
                    participations = participations.filter(p =>
                        !(p.student_id === change.student_id && p.event_id === change.event_id)
                    );
                }
            });
            // --- End of new logic ---

            await showDialog({
                title: 'Success',
                message: 'Participation updated: Added ' + updated.added + ' students. Removed: ' + updated.removed + ' students.',
                type: 'alert'
            });
        } else {
            // Only show the server error if we didn't already have a client-side error
            if (errors.length === 0) {
                 await showDialog({
                    title: 'Error',
                    message: 'Error updating participation. You may be trying to change participation for the students you are not authorized to. Some students may not be in the class/house you manage.',
                    type: 'alert'
                });
            }
        }

        if (errors.length > 0) {
            showToast(errors.join('\n'), true);
        }
        // --- MODIFICATION: Removed 'else' block with redundant showToast ---

    } else if (event.game_type === 'Grouped') {
        // --- NEW LOGIC FOR 'Grouped' game type ---

        const groupSize = event.group_size;

        // 1. Process existing groups (to find removals)
        // Any student *unchecked* from an existing group is removed.
        const groupContainers = gameStudentListContainer.querySelectorAll('.participant-group[data-group-id]:not([data-group-id="new"])');

        groupContainers.forEach(container => {
            const groupId = container.dataset.groupId;
            const desiredStudentIdsInGroup = new Set();
            container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                desiredStudentIdsInGroup.add(cb.value);
            });

            // Find all students *currently* in this group in our data
            const currentStudentIdsInGroup = new Set(
                participations.filter(p => p.participant_group_id === groupId).map(p => p.student_id)
            );

            currentStudentIdsInGroup.forEach(studentId => {
                if (!desiredStudentIdsInGroup.has(studentId)) {
                    // This student was removed (unchecked) from this group
                    changes.push({
                        change: "remove",
                        student_id: studentId,
                        event_id: selectedEventId,
                        participant_group_id: groupId
                    });
                    
                    // --- MODIFICATION: Do NOT filter participations yet ---
                }
            });
        });

        // 2. Process the "new" students
        // We create new groups from them
        const newStudentsContainer = gameStudentListContainer.querySelector('.participant-group[data-group-id="new"]');
        const newStudentCheckboxes = newStudentsContainer.querySelectorAll('input[type="checkbox"]:checked');
        const newStudentIds = Array.from(newStudentCheckboxes).map(cb => cb.value);

        // Create new groups for them, respecting groupSize
        for (let i = 0; i < newStudentIds.length; i += groupSize) {
            const newGroupId = generateUUID();
            const groupMembers = newStudentIds.slice(i, i + groupSize);

            if (groupMembers.length > 0 && groupMembers.length < groupSize) {
                showToast(`Warning: You created an incomplete group of ${groupMembers.length} student(s).`, true);
            }

            groupMembers.forEach(studentId => {
                // Check if student is already in (this shouldn't happen, but good to check)
                const alreadyIn = participations.some(p =>
                    p.student_id === studentId && p.event_id === selectedEventId
                );

                if (!alreadyIn) {
                    // --- MODIFICATION: Do NOT push to participations yet ---
                    
                    changes.push({
                        change: "add",
                        student_id: studentId,
                        event_id: selectedEventId,
                        participant_group_id: newGroupId
                    });
                }
            });
        }
        
        // Only proceed if there are actual changes
        if (changes.length === 0) {
             onGameOrHouseSelect(); // Refresh
             return;
        }

        showProcessingDialog();
        const updated = await syncParticipationChanges(changes);
        hideProcessingDialog();

        if (updated) {
            // --- NEW: Apply changes locally *only* on success ---
            changes.forEach(change => {
                if (change.change === "add") {
                    participations.push({
                        student_id: change.student_id,
                        event_id: change.event_id,
                        participant_group_id: change.participant_group_id
                    });
                } else if (change.change === "remove") {
                    participations = participations.filter(p =>
                        !(p.student_id === change.student_id && p.event_id === change.event_id)
                    );
                }
            });
            // --- End of new logic ---

            await showDialog({
                title: 'Success',
                message: 'Participation updated: Added ' + updated.added + ' students. Removed: ' + updated.removed + ' students.',
                type: 'alert'
            });
        } else {
            await showDialog({
                title: 'Error',
                message: 'Error updating participation. You may be trying to change participation for the students you are not authorized to. Some students may not be in the class/house you manage.',
                type: 'alert'
            });
        }
    }

    // 3. Refresh the view (works for all cases)
    onGameOrHouseSelect();
}
         
         // ---=======================================---
         // ---          INITIALIZATION             ---
         // ---=======================================---
         
         document.addEventListener('DOMContentLoaded', async () => {
             showProcessingDialog();
             try {
             const isAuthenticated = await checkAuth();
             if (!isAuthenticated) {
                window.location = "https://myjvp.in/teachers/?ref=" + encodeURIComponent(window.location.href);
                return;
             }
             } catch (error) {
             console.error('Auth check error:', error);
             }
             // Fetch student list
             students = await selectData('students', false, 'id, name, class, house, gender', [], [], 'name');
             // Fetch events list
             events = await selectData('sport_events', false, '*', [], [], 'id');
             // Fetch participation data
             participations = await selectData('sport_participations', false, '*');
             hideProcessingDialog();
             initStudentView();
             initGameView();
         });
         
      </script>
   </body>
</html>
