<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Participation Status</title>
    <!-- Supabase CRUD Functions -->
    <script type="module" src="https://myjvp.in/commons/supabase-crud.js"></script>
    <!-- Dialog Box Styles -->
    <link rel="stylesheet" href="https://myjvp.in/commons/dialog.css">
    <!-- Dialog Box Scripts -->
    <script src="https://myjvp.in/commons/dialog.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --success: #10b981;
            --house-ruby: #dc2626;
            --house-emerald: #059669;
            --house-sapphire: #2563eb;
            --house-topaz: #d97706;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .header-controls { display: flex; gap: 1rem; align-items: center; }

        button.btn-print {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button.btn-print:hover { background-color: var(--primary-dark); }

        /* Layout */
        .container {
            display: flex;
            flex: 1;
            gap: 2rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Sidebar / Filters */
        aside.filters {
            width: 300px;
            flex-shrink: 0;
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: fit-content;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            position: sticky;
            top: 90px;
        }

        .filter-section { margin-bottom: 1.5rem; }
        .filter-header { font-weight: 600; margin-bottom: 0.75rem; display: flex; justify-content: space-between; font-size: 0.95rem;}
        
        /* Scrollable Checkbox Area */
        .checkbox-group {
            max-height: 140px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            background: #fafafa;
        }
        
        /* Custom Scrollbar */
        .checkbox-group::-webkit-scrollbar { width: 6px; }
        .checkbox-group::-webkit-scrollbar-track { background: #f1f1f1; }
        .checkbox-group::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .checkbox-item:hover { background-color: #eef2ff; }
        .checkbox-item input { margin-right: 8px; accent-color: var(--primary); cursor: pointer; }
        .checkbox-item label { cursor: pointer; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Main Content / Table */
        main.content { flex: 1; overflow: hidden; }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .table-wrapper {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; }
        
        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-light);
            position: sticky;
            top: 0;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f8fafc; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        
        .house-badge { color: white; width: 80px; text-align: center; display: inline-block;}
        .house-Ruby { background-color: var(--house-ruby); }
        .house-Emerald { background-color: var(--house-emerald); }
        .house-Sapphire { background-color: var(--house-sapphire); }
        .house-Topaz { background-color: var(--house-topaz); }

        .gender-badge { font-weight: bold; color: var(--text-light); }

        /* Responsive */
        @media (max-width: 1024px) {
            .container { flex-direction: column; }
            aside.filters { width: 100%; max-height: none; position: relative; top: 0; }
            .checkbox-group { max-height: 100px; }
        }

        /* PRINT STYLES */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; display: block; }
            header { padding: 0; box-shadow: none; border-bottom: 2px solid black; margin-bottom: 20px; position: relative; }
            .btn-print, aside.filters { display: none !important; }
            .container { padding: 0; display: block; max-width: 100%; }
            .table-wrapper { box-shadow: none; border: none; overflow: visible; }
            table { border: 1px solid black; width: 100%; font-size: 12px; }
            th, td { padding: 6px; border: 1px solid black; color: black; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            .badge { color: black !important; background: none !important; border: none; font-weight: bold; text-align: left; padding: 0; }
            tr { break-inside: avoid; }
            .stats-bar { display: none; }
            
            /* Print Title Append */
            header h1::after {
                content: " - Filtered Student List";
                font-size: 1rem;
                font-weight: normal;
            }
        }
    </style>
</head>
<body class="light-theme">

<header>
    <h1>School Sports Manager</h1>
    <div class="header-controls">
        <button class="btn-print" onclick="window.print()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
            Print List
        </button>
    </div>
</header>

<div class="container">
    <aside class="filters">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h3>Filters</h3>
            <button onclick="resetFilters()" style="border:none; background:none; color:var(--primary); cursor:pointer; font-size:0.85rem; text-decoration:underline;">Reset All</button>
        </div>

        <div class="filter-section">
            <div class="filter-header">House</div>
            <div class="checkbox-group" id="filter-house"></div>
        </div>

        <div class="filter-section">
            <div class="filter-header">Class</div>
            <div class="checkbox-group" id="filter-class"></div>
        </div>

        <div class="filter-section">
            <div class="filter-header">Gender</div>
            <div class="checkbox-group" id="filter-gender"></div>
        </div>

        <div class="filter-section">
            <div class="filter-header">Participating In</div>
            <div class="checkbox-group" id="filter-participating"></div>
        </div>

        <div class="filter-section">
            <div class="filter-header">Not Participating Status</div>
            <div class="checkbox-group" id="filter-not-participating"></div>
        </div>
    </aside>

    <main class="content">
        <div class="stats-bar">
            <span id="record-count">Showing 0 students</span>
            <span>Generated on: <span id="current-date"></span></span>
        </div>

        <div class="table-wrapper">
            <table id="student-table">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Class</th>
                        <th>Gender</th>
                        <th>House</th>
                        <th>Already Participated</th>
                        <th>Not Participating Status</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </main>
</div>

      <!-- Dialog Overlay Starts -->
      <div id="dialog-overlay" class="dialog-overlay">
         <div class="dialog-box" id="dialog-box">
            <div class="dialog-header" id="dialog-header">Title</div>
            <div class="dialog-message" id="dialog-message">Message goes here</div>
            <div class="dialog-buttons" id="dialog-buttons">
               <!-- Buttons will be added dynamically -->
            </div>
         </div>
      </div>
      <!-- Dialog Overlay Ends -->

<script>
    // --- 1. Data (To be fetched from the server) ---
    let rawData = [];

    // State for filters
    let activeFilters = {
        house: new Set(),
        class: new Set(),
        gender: new Set(),
        participated: new Set(),
        not_participating: new Set()
    };

    // --- 2. Initialization Logic ---

    async function init() {
        try {
            showProcessingDialog();
            
            // Fetch data
            rawData = await invokeFunction('get_students_missing_participation');

            // Debug: Check if data is null or empty
            if (!rawData) {
                console.error("Data is null/undefined");
                rawData = [];
            }

            console.log("Fetched Data:", rawData);
            document.getElementById('current-date').innerText = new Date().toLocaleDateString();
            
            generateFilterUI();
            renderTable(rawData);
        } catch (error) {
            console.error("Error initializing:", error);
            alert("Error loading data. Check console.");
        } finally {
            hideProcessingDialog();
        }
    }

    // Helper to extract unique values sorted (FIXED FOR NULLS)
    function getUniqueValues(key) {
        const values = new Set(rawData.map(item => item[key]));
        
        return Array.from(values).sort((a, b) => {
            // SAFE GUARD: Convert null/undefined to empty string for comparison
            const valA = (a === null || a === undefined) ? "" : String(a);
            const valB = (b === null || b === undefined) ? "" : String(b);
            
            return valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'});
        });
    }

    function getParticipationValues() {
        return getUniqueValues('already_participated');
    }

    function generateFilterUI() {
        createCheckboxList('filter-house', getUniqueValues('house'), 'house');
        createCheckboxList('filter-class', getUniqueValues('class'), 'class');
        createCheckboxList('filter-gender', getUniqueValues('gender'), 'gender');
        createCheckboxList('filter-participating', getParticipationValues(), 'participated');
        createCheckboxList('filter-not-participating', getUniqueValues('not_participating'), 'not_participating');
    }

    // (FIXED FOR NULL IDS)
    function createCheckboxList(containerId, values, filterType) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; 

        values.forEach(val => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'checkbox-item';

            // Handle display text vs actual value
            // If val is null/empty string, display "None/Unknown"
            const displayText = (val === null || val === "" || val === undefined) ? "None" : val;
            
            // create a safe ID string (remove spaces, handle nulls)
            const safeIdString = String(displayText).replace(/[^a-zA-Z0-9-_]/g, '-');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `${filterType}-${safeIdString}`;
            
            // We store the ORIGINAL value (even if null) to match against rawData later
            // We attach the value object directly to the element to avoid string conversion issues
            checkbox.dataset.val = JSON.stringify(val); 
            
            checkbox.addEventListener('change', (e) => {
                // Parse the original value back
                const originalVal = JSON.parse(e.target.dataset.val);

                if (e.target.checked) {
                    activeFilters[filterType].add(originalVal);
                } else {
                    activeFilters[filterType].delete(originalVal);
                }
                applyFilters();
            });

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.innerText = displayText;
            label.title = displayText;

            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(label);
            container.appendChild(itemDiv);
        });
    }

    // --- 3. Filtering Logic ---

    function applyFilters() {
        const filteredData = rawData.filter(student => {
            const matchHouse = activeFilters.house.size === 0 || activeFilters.house.has(student.house);
            const matchClass = activeFilters.class.size === 0 || activeFilters.class.has(student.class);
            const matchGender = activeFilters.gender.size === 0 || activeFilters.gender.has(student.gender);
            
            // Note: student.already_participated might be null in DB, whereas in dummy data it was "None"
            const matchPart = activeFilters.participated.size === 0 || activeFilters.participated.has(student.already_participated);
            const matchNotPart = activeFilters.not_participating.size === 0 || activeFilters.not_participating.has(student.not_participating);

            return matchHouse && matchClass && matchGender && matchPart && matchNotPart;
        });

        renderTable(filteredData);
    }

    function resetFilters() {
        for (let key in activeFilters) {
            activeFilters[key].clear();
        }
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        applyFilters();
    }

    // --- 4. Rendering ---

    function renderTable(data) {
        const tbody = document.querySelector('#student-table tbody');
        const countSpan = document.getElementById('record-count');
        tbody.innerHTML = '';

        countSpan.innerText = `Showing ${data.length} student${data.length !== 1 ? 's' : ''}`;

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem; color: #888;">No students match the selected filters.</td></tr>`;
            return;
        }

        data.forEach(student => {
            const row = document.createElement('tr');
            
            // Handle null values for display
            const house = student.house || "Unknown";
            const houseClass = `house-${house}`;
            const gender = student.gender || "-";
            const participated = student.already_participated || "None"; // Display "None" if null
            const notParticipating = student.not_participating || "Unknown";

            row.innerHTML = `
                <td style="font-weight:600;">${student.student_name || "N/A"}</td>
                <td>${student.class || "N/A"}</td>
                <td><span class="gender-badge">${gender}</span></td>
                <td><span class="badge ${houseClass}">${house}</span></td>
                <td>${participated}</td>
                <td style="color: #555; font-size: 0.85rem;">${notParticipating}</td>
            `;
            tbody.appendChild(row);
        });
    }

    window.onload = init;

</script>


</body>
</html>
