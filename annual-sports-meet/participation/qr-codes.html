<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="robots" content="noindex, nofollow">
      <title>Sports Meet QR Badges - JVP</title>
      <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
      <script type="module" src="https://myjvp.in/commons/supabase-crud.js"></script>
      <style>
         * {
            box-sizing: border-box;
         }
         body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
         }
         h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #1a1a1a;
         }

         /* Grid Layout */
         #qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 280px); /* Fixed width for consistency */
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
         }

         /* Badge Card Design */
         .qr-card {
            background: #fff;
            padding: 10px;
            border: 2px solid #000; /* Solid border for cutting guide */
            border-radius: 0; /* Square corners for easier cutting */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            page-break-inside: avoid; /* Crucial for print */
         }

         /* Typography within the Badge */
         .school-name {
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #333;
            width: 100%;
            padding-bottom: 2px;
         }

         canvas {
            margin: 2px 0;
         }

         .student-name {
            font-size: 16px;
            font-weight: 800;
            margin: 2px 0;
            line-height: 1.1;
            text-transform: uppercase;
         }

         .student-meta {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
         }

         .games-list {
            font-size: 12px;
            line-height: 1.2;
            margin: 4px 0;
            font-style: italic;
            font-weight: bold;
            /*background: #eee;*/
            padding: 4px;
            border-radius: 4px;
            width: 100%;
         }

         .credits {
            font-size: 10px;
            color: #666;
            color: black;
            font-weight: bold;
            margin-top: 4px;
            border-top: 1px solid #ddd;
            width: 100%;
            padding-top: 2px;
         }

         /* Controls & UI */
         button {
            display: inline-block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #002B5B;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
         }
         button:hover {
            background-color: #004080;
         }
         #print-btn {
            margin-top: 30px;
            display: block;
         }
         
         /* Loading Animation */
         .center-text {
            font-size: 30px;
            font-weight: bold;
            color: #002B5B;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
         }

         /* Class Selection Dialog */
         #class-dialog-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
         }
         #class-dialog {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
         }
         #class-select {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
         }

         /* Print specific styles */
         @media print {
            button, h1, #class-dialog-overlay, #generating-text {
               display: none !important;
            }
            body {
               background-color: white;
               padding: 0;
               margin: 0;
            }
            #qr-grid {
               display: block; /* Use block to allow floating if needed, or stick to grid */
               display: grid;
               grid-template-columns: repeat(3, 1fr); /* Fit 3 per row on A4 usually */
               gap: 10px;
               margin: 0;
               padding: 10px;
            }
            .qr-card {
               border: 1px dashed #999; /* Dashed lines for cutting */
               break-inside: avoid;
               box-shadow: none;
            }
         }
      </style>
   </head>
   <body>
      <h1>Annual Sports Meet 2025-26 - Blazer Tags</h1>
      
      <div id="class-dialog-overlay">
        <div id="class-dialog">
            <h2>Select Participants</h2>
            <p>Choose a class to generate badges for.</p>
            <select id="class-select">
                <option value="all">All Classes</option>
                </select>
            <button id="select-class-btn">Generate Badges</button>
        </div>
      </div>
      
      <div id="qr-grid"></div>
      <button id="print-btn" onclick="window.print()" style="display:none;">Print QR Badges</button>
      
      <div id="generating-text" class="center-text">Processing Data...</div>

      <script>
         // Configuration
         const QR_SIZE = 120; // Slightly smaller to fit meta data
         const TARGET_URL_BASE = "https://myjvp.in/annual-sports-meet/participation/my-events.html?token=";
         
         let globalRawData = [];

         // Helper: Capitalize Words
         function capitalizeWords(str) {
             if (!str) return '';
             return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
         }

         // Helper: Populate Class Dropdown
         function populateClassOptions() {
             const classSelect = document.getElementById('class-select');
             // Standard 1-10
             for (let grade = 1; grade <= 10; grade++) {
                 for (let section = 1; section <= 4; section++) {
                     const className = `${grade}-A${section}`;
                     const option = document.createElement('option');
                     option.value = className;
                     option.textContent = className;
                     classSelect.appendChild(option);
                 }
             }
             // Senior Secondary
             ['11-SCI', '11-COM', '11-HUM', '12-SCI', '12-COM', '12-HUM'].forEach(cls => {
                 const option = document.createElement('option');
                 option.value = cls;
                 option.textContent = cls;
                 classSelect.appendChild(option);
             });
         }

         // Core Logic: Aggregate Raw Data by Student (Token)
         function processAndAggregateData(rawData, filterClass) {
             const studentMap = {};

             rawData.forEach(row => {
                 // Filter by class if specific class selected
                 if (filterClass !== 'all' && row.student_class !== filterClass) {
                     return;
                 }

                 const token = row.access_token;
                 
                 // Create entry if not exists
                 if (!studentMap[token]) {
                     studentMap[token] = {
                         name: row.student_name,
                         class: row.student_class,
                         house: row.student_house,
                         access_token: token,
                         games: new Set() // Use Set to avoid duplicates
                     };
                 }
                 
                 // Add game
                 if (row.game_name) {
                     studentMap[token].games.add(row.game_name);
                 }
             });

             // Convert Map to Array and Sort
             const processedArray = Object.values(studentMap).map(student => ({
                 ...student,
                 gamesList: Array.from(student.games).join(', ') // Convert Set to String
             }));

             // Sort: Class first, then Name
             processedArray.sort((a, b) => {
                 // Sort by class (simple string comparison works for "3-A3" vs "4-A2")
                 // For stricter numeric sorting, more logic is needed, but string usually suffices for school formats
                 if (a.class !== b.class) return a.class.localeCompare(b.class, undefined, {numeric: true});
                 return a.name.localeCompare(b.name);
             });

             return processedArray;
         }

         // UI: Generate DOM Elements
         function renderBadges(students) {
             const qrGrid = document.getElementById('qr-grid');
             qrGrid.innerHTML = '';

             if (students.length === 0) {
                 qrGrid.innerHTML = '<p style="text-align:center; width:100%;">No participants found for this selection.</p>';
                 return;
             }

             students.forEach(student => {
                 const card = document.createElement('div');
                 card.className = 'qr-card';

                 // Header
                 const header = document.createElement('div');
                 header.className = 'school-name';
                 header.innerText = 'Jamna Vidyapeeth';

                 // Canvas for QR
                 const canvas = document.createElement('canvas');

                 // Meta Data Container
                 const metaDiv = document.createElement('div');
                 metaDiv.style.width = '100%';

                 // Student Details
                 const nameDiv = document.createElement('div');
                 nameDiv.className = 'student-name';
                 nameDiv.innerText = capitalizeWords(student.name);

                 const detailsDiv = document.createElement('div');
                 detailsDiv.className = 'student-meta';
                 detailsDiv.innerHTML = `${student.class} <span style="margin:0 4px">â€¢</span> ${student.house}`;

                 // Games List
                 const gamesDiv = document.createElement('div');
                 gamesDiv.className = 'games-list';
                 gamesDiv.innerText = student.gamesList || 'No Games';

                 // Credits
                 const creditsDiv = document.createElement('div');
                 creditsDiv.className = 'credits';
                 creditsDiv.innerText = 'System by Mr. Sourabh Suneja';

                 // Assemble
                 card.appendChild(header);
                 card.appendChild(canvas);
                 
                 metaDiv.appendChild(nameDiv);
                 metaDiv.appendChild(detailsDiv);
                 metaDiv.appendChild(gamesDiv);
                 
                 card.appendChild(metaDiv);
                 card.appendChild(creditsDiv);

                 qrGrid.appendChild(card);

                 // Draw QR Code
                 const qrUrl = TARGET_URL_BASE + student.access_token;
                 QRCode.toCanvas(canvas, qrUrl, { width: QR_SIZE, margin: 1 }, (error) => {
                     if (error) console.error(error);
                 });
             });

             document.getElementById('print-btn').style.display = 'block';
         }

         // Main Flow
         async function initSystem(selectedClass) {
             const loader = document.getElementById('generating-text');
             loader.style.display = 'block';

             try {
                 // 1. Fetch Data (if not already fetched)
                 if (globalRawData.length === 0) {
                     globalRawData = await invokeFunction('get_sport_participants');
                 }

                 // 2. Process Data
                 const students = processAndAggregateData(globalRawData, selectedClass);

                 // 3. Render
                 renderBadges(students);

             } catch (error) {
                 console.error("Error:", error);
                 alert("Failed to load data. Check console.");
             } finally {
                 loader.style.display = 'none';
             }
         }

         // Events
         window.onload = function() {
             populateClassOptions();

             document.getElementById('select-class-btn').addEventListener('click', () => {
                 const cls = document.getElementById('class-select').value;
                 document.getElementById('class-dialog-overlay').style.display = 'none';
                 initSystem(cls);
             });
         };
      </script>
   </body>
</html>
