<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Sports Meet 2025-26 - Results</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="module" src="https://myjvp.in/commons/supabase-crud.js"></script>

    <style>
        :root {
            /* House Colors - Adjusted for better contrast */
            --ruby: #e74c3c;
            --ruby-light: #fadbd8;
            --emerald: #27ae60;
            --emerald-light: #d5f5e3;
            --sapphire: #2980b9;
            --sapphire-light: #d4e6f1;
            --topaz: #f39c12; /* Darkened slightly for text visibility */
            --topaz-light: #fdebd0;
            
            --dark: #2c3e50;
            --text-main: #34495e;
            --text-light: #7f8c8d;
            --bg-body: #f8f9fa;
            --white: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        * {
            max-height: 99999999px;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* --- Header Section --- */
        header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            color: var(--dark);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 1.6rem;
            font-weight: 700;
        }

        h2 {
            font-family: 'Poppins', sans-serif;
            margin: 5px 0 15px;
            font-weight: 500;
            color: var(--text-light);
            font-size: 1.4rem;
        }

        .meta-badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .meta-badge {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- Loading Spinner --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Scoreboard Section --- */
        .scoreboard-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .score-card {
            background: var(--white);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid transparent;
            transition: transform 0.2s ease;
        }

        .score-card:hover { /*transform: translateY(-3px); */}

        .score-card h3 { 
            margin: 0; 
            font-size: 1.1rem; 
            color: var(--text-light); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            font-weight: 600;
        }
        
        .score-card .points { 
            font-size: 3rem; 
            font-family: 'Poppins', sans-serif;
            font-weight: 700; 
            margin: 10px 0; 
            color: var(--dark); 
        }
        
        .score-card .rank { 
            font-size: 0.85rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            padding: 6px 12px; 
            border-radius: 20px; 
            display: inline-block;
            background: #f1f3f5;
            color: #555;
        }

        .score-card .icon-bg {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(15deg);
        }

        /* House Specific Styles */
        .border-Ruby { border-bottom-color: var(--ruby); }
        .border-Ruby .points { color: var(--ruby); }
        .border-Ruby .icon-bg { color: var(--ruby); }
        .badge-Ruby { background: var(--ruby-light); color: #c0392b; }

        .border-Emerald { border-bottom-color: var(--emerald); }
        .border-Emerald .points { color: var(--emerald); }
        .border-Emerald .icon-bg { color: var(--emerald); }
        .badge-Emerald { background: var(--emerald-light); color: #1e8449; }

        .border-Sapphire { border-bottom-color: var(--sapphire); }
        .border-Sapphire .points { color: var(--sapphire); }
        .border-Sapphire .icon-bg { color: var(--sapphire); }
        .badge-Sapphire { background: var(--sapphire-light); color: #1f618d; }

        .border-Topaz { border-bottom-color: var(--topaz); }
        .border-Topaz .points { color: var(--topaz); }
        .border-Topaz .icon-bg { color: var(--topaz); }
        .badge-Topaz { background: var(--topaz-light); color: #9a7d0a; }

        /* --- Final Judgement (Podium) --- */
        .winner-banner {
            background: linear-gradient(135deg, var(--dark) 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .winner-banner i { font-size: 2rem; color: #f1c40f; }
        .winner-text { font-size: 1.1rem; }
        .winner-text strong { color: #f1c40f; font-size: 1.1rem; }

        /* --- Data Table --- */
        .table-container {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 40px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px; /* Applies to screen only */
        }

        thead {
            background-color: var(--dark);
            color: var(--white);
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 500;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        td {
            padding: 16px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: top;
            font-size: 0.95rem;
        }

        tr:last-child td { border-bottom: none; }
        tr:not(:first-child):hover { background-color: #f8fcfd; }


        .game-col { font-weight: 600; color: var(--dark); font-family: 'Poppins', sans-serif;}
        
        /* Inner cell styling */
        .winner-cell { display: flex; flex-direction: column; gap: 4px; }
        .winner-name { font-weight: 600; color: #333; }
        
        .house-badge-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            width: fit-content;
        }
        
        .bg-Ruby { background-color: var(--ruby); color: white; }
        .bg-Emerald { background-color: var(--emerald); color: white; }
        .bg-Sapphire { background-color: var(--sapphire); color: white; }
        .bg-Topaz { background-color: var(--topaz); color: white; }
        .bg-NIL { background-color: #e0e0e0; color: #888; }

        /* Game Type Badges */
        .badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-Team { background: #e8daef; color: #8e44ad; }
        .badge-Ind { background: #d6eaf8; color: #2980b9; }
        .badge-Grp { background: #d1f2eb; color: #16a085; }

        /* --- Signatures --- */
        .signatures {
            margin-top: 60px;
            display: flex;
            justify-content: space-around;
            padding-top: 20px;
            page-break-inside: avoid;
        }

        .sig-block {
            text-align: center;
            width: 200px;
        }
        
        .sig-line {
            width: 100%;
            height: 1px;
            background-color: #ccc;
            margin-bottom: 10px;
        }

        .sig-block p { margin: 5px 0; font-size: 1rem; font-weight: 700; color: var(--dark); font-family: 'Poppins', sans-serif;}
        .sig-block span { display: block; font-size: 0.85rem; color: #777; font-weight: 500; }

        /* --- Print Button --- */
        .action-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .btn-print {
            padding: 10px 20px;
            background: var(--dark);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .btn-print:hover { background: #34495e; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* --- PRINT STYLES --- */
        @media print {
            /* 1. Page Margin & Size Fix */
            @page { 
                size: A4 portrait; 
                margin: 10mm; /* Reduce default margins to maximize width */
            }

            body { background-color: white; font-size: 10pt; color: #000; -webkit-print-color-adjust: exact; }
            .container { width: 100%; max-width: 100%; padding: 0; margin: 0; }
            .action-bar, #loading-overlay { display: none !important; }
            
            header { margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            h1 { font-size: 1.5rem; color: #000; }
            h2 { font-size: 1.1rem; color: #333; margin-bottom: 5px;}
            
            .meta-badge { border: 1px solid #ccc; color: #000 !important; background: transparent !important; }
            
            /* Scoreboard Print */
            .scoreboard-section { gap: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; }
            .score-card { 
                box-shadow: none; 
                border: 1px solid #ccc; 
                padding: 8px; 
                flex: 1;
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .score-card .points { font-size: 1.4rem; color: #000 !important; margin: 5px 0;}
            .score-card h3 { color: #000; font-size: 0.9rem; }
            .score-card .rank { background: transparent; border: 1px solid #ddd; font-size: 0.75rem; padding: 2px 6px;}
            .score-card .icon-bg { display: none; }
            
            /* Winner Banner Print */
            .winner-banner { 
                background: white; 
                border: 2px solid #000; 
                color: black; 
                box-shadow: none; 
                padding: 8px;
                margin-bottom: 15px;
            }
            .winner-banner i { display: none; }
            .winner-banner strong { color: black !important; text-decoration: underline; }

            /* 2. Table Layout Fixes */
            .table-container { box-shadow: none; margin-bottom: 20px;}
            .table-responsive { overflow: visible; display: block; width: 100%; }
            
            table { 
                width: 100% !important; 
                min-width: 0 !important; /* CRITICAL FIX: Override screen min-width */
                border: 1px solid #000; 
                table-layout: fixed; /* CRITICAL FIX: Respect percentages strictly */
            }

            thead { background-color: #eee !important; color: black !important; }
            
            th { 
                border-bottom: 2px solid #000; 
                padding: 6px 4px; /* Reduced padding */
                font-size: 0.8rem; 
                word-wrap: break-word;
            }

            td { 
                border-bottom: 1px solid #ccc; 
                padding: 4px 4px; /* Reduced padding */
                font-size: 0.8rem; /* Smaller font for print */
                overflow-wrap: break-word; /* Ensure long names break to next line */
                word-wrap: break-word;
                hyphens: auto;
            }
            
            .winner-cell {
                display: block; /* Stack vertically, removed flex to prevent width issues */
            }

            .winner-name { font-size: 0.8rem; margin-bottom: 2px; }

            /* Ensure colors print slightly for identification or fallback to borders */
            .house-badge-pill { 
                border: 1px solid #999; 
                color: black !important; 
                background: white !important; 
                font-weight: bold;
                padding: 0px 4px;
                font-size: 0.7rem;
            }
            
            /* Add letter indicators for B/W printing clarity */
            .bg-Ruby::after { content: " (R)"; font-size: 0.8em; }
            .bg-Emerald::after { content: " (E)"; font-size: 0.8em; }
            .bg-Sapphire::after { content: " (S)"; font-size: 0.8em; }
            .bg-Topaz::after { content: " (T)"; font-size: 0.8em; }

            .signatures { margin-top: 30px; }
            .sig-line { background-color: #000; }
            .sig-block p { font-size: 0.9rem; }

            tr { break-inside: avoid; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="font-weight: 500; color: #555;">Fetching Winners...</div>
</div>

<div class="container">
    <div class="action-bar">
        <button onclick="window.print()" class="btn-print"><i class="fas fa-print"></i> Print Results</button>
    </div>

    <header>
        <h1>Jamna Vidyapeeth<br><i class="fas fa-medal" style="color: var(--topaz); margin-right: 10px;"></i> </h1>
        <h2>Annual Sports Meet 2025-26</h2>
        <div class="meta-badges">
            <span class="meta-badge badge-Ruby"><i class="fas fa-shield-alt"></i> Ruby</span>
            <span class="meta-badge badge-Emerald"><i class="fas fa-shield-alt"></i> Emerald</span>
            <span class="meta-badge badge-Sapphire"><i class="fas fa-shield-alt"></i> Sapphire</span>
            <span class="meta-badge badge-Topaz"><i class="fas fa-shield-alt"></i> Topaz</span>
        </div>
    </header>

    <div class="scoreboard-section" id="scoreboard">
        </div>

    <div id="winner-banner-container">
        </div>

    <div class="table-container">
        <div class="table-responsive">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th style="width: 20%">Game / Event</th>
                        <th style="width: 10%">Type</th>
                        <th style="width: 8%">Class</th>
                        <th style="width: 20%"><i class="fas fa-trophy" style="color: #f1c40f"></i> 1st Position</th>
                        <th style="width: 20%"><i class="fas fa-medal" style="color: #95a5a6"></i> 2nd Position</th>
                        <th style="width: 22%"><i class="fas fa-medal" style="color: #cd7f32"></i> 3rd Position</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div class="signatures">
        <div class="sig-block">
            <div class="sig-line"></div>
            <p>Sourabh Suneja</p>
            <span>Technical Coordinator</span>
        </div>
        <div class="sig-block">
            <div class="sig-line"></div>
            <p>Kajal Jha & Ritu Das</p>
            <span>Activity Coordinators</span>
        </div>
        <div class="sig-block">
            <div class="sig-line"></div>
            <p>Mrs. Savita Devi</p>
            <span>Principal</span>
        </div>
    </div>
</div>

<script>
    // --- 1. DATA SOURCE ---
    let winners = [];

    // --- 2. LOGIC CONFIGURATION ---
    const housePoints = {
        "Ruby": 0,
        "Emerald": 0,
        "Sapphire": 0,
        "Topaz": 0
    };

    const rules = {
        standard: { 1: 10, 2: 7, 3: 5 }, // Individual & Grouped
        team: { 1: 20, 2: 14, 3: 0 }     // Team events
    };

    // --- 3. PROCESSING FUNCTIONS ---

    function calculatePoints() {
        // Reset points
        Object.keys(housePoints).forEach(h => housePoints[h] = 0);

        winners.forEach(event => {
            const isTeam = event.gametype.toLowerCase() === 'team';
            const pointsRule = isTeam ? rules.team : rules.standard;

            // Helper to process a specific position (1, 2, or 3)
            const processPosition = (houseString, position) => {
                // If Team event, there is no 3rd place points
                if (isTeam && position === 3) return; 

                if (!houseString || houseString === "NIL") return;

                // Handle split winners (e.g. "Ruby/Emerald")
                const winnersList = houseString.split('/').map(s => s.trim());
                
                winnersList.forEach(house => {
                    if (housePoints.hasOwnProperty(house)) {
                        housePoints[house] += pointsRule[position];
                    }
                });
            };

            processPosition(event.winnerhouse1, 1);
            processPosition(event.winnerhouse2, 2);
            processPosition(event.winnerhouse3, 3);
        });
    }

    function renderTable() {
        const tbody = document.querySelector("#resultsTable tbody");
        tbody.innerHTML = "";

        winners.forEach(row => {
            // Determine badge type for styling
            let typeBadge = "badge-Ind";
            if(row.gametype === 'Team') typeBadge = "badge-Team";
            else if(row.gametype === 'Grouped') typeBadge = "badge-Grp";

            // Helper to format winner cell
            const formatWinnerCell = (name, house) => {
                if(house === 'NIL') return '<span style="color:#ccc; font-size:0.85rem">NIL</span>';
                
                // Handle multiple houses for display badges
                const houses = house.split('/').map(h => h.trim());
                let badges = houses.map(h => `<span class="house-badge-pill bg-${h}">${h}</span>`).join(' ');
                
                return `
                    <div class="winner-cell">
                        <div class="winner-name">${name}</div>
                        <div>${badges}</div>
                    </div>
                `;
            };

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="game-col">${row.game}</td>
                <td><span class="badge ${typeBadge}">${row.gametype}</span></td>
                <td style="font-weight:500;">${row.classcategory}</td>
                <td>${formatWinnerCell(row.winner1, row.winnerhouse1)}</td>
                <td>${formatWinnerCell(row.winner2, row.winnerhouse2)}</td>
                <td>${formatWinnerCell(row.winner3, row.winnerhouse3)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderScoreboard() {
        const board = document.getElementById('scoreboard');
        board.innerHTML = "";

        // Convert object to array for sorting
        const sortedHouses = Object.entries(housePoints).sort((a, b) => b[1] - a[1]);

        // Calculate Rank (handle ties)
        let currentRank = 1;
        
        sortedHouses.forEach((item, index) => {
            const [house, points] = item;
            
            // Check for tie with previous
            if (index > 0 && points < sortedHouses[index-1][1]) {
                currentRank = index + 1;
            }

            const card = document.createElement('div');
            card.className = `score-card border-${house}`;
            
            // Add icon depending on rank
            let icon = 'fa-shield-alt';
            if(currentRank === 1) icon = 'fa-trophy';
            
            card.innerHTML = `
                <i class="fas ${icon} icon-bg"></i>
                <h3>${house} House</h3>
                <div class="points">${points}</div>
                <div class="rank">Rank ${currentRank}</div>
            `;
            board.appendChild(card);
        });

        // Update Final Judgement Banner
        const banner = document.getElementById('winner-banner-container');
        const winnerName = sortedHouses[0][0];
        const winnerPoints = sortedHouses[0][1];
        
        // Check if there is a tie for 1st place
        let winnersText = `${winnerName} House`;
        if (sortedHouses.length > 1 && sortedHouses[1][1] === winnerPoints) {
            winnersText += ` & ${sortedHouses[1][0]} House`;
        }

        banner.innerHTML = `
            <div class="winner-banner">
                <i class="fas fa-crown"></i>
                <div class="winner-text">
                    Congratulations to <strong>${winnersText}</strong> for winning with <strong>${winnerPoints} points</strong>!
                </div>
                <i class="fas fa-crown"></i>
            </div>
        `;
    }

    // --- 4. INITIALIZATION ---
    window.onload = async function() {
        const loader = document.getElementById('loading-overlay');
        try {
            winners = await selectData('sport_winners', false, '*', [], [], 'classcategory');
            calculatePoints();
            renderScoreboard();
            renderTable();
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("Failed to load data. Please refresh.");
        } finally {
            // Hide loader with a slight fade effect
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300);
        }
    };

</script>

</body>
</html>
