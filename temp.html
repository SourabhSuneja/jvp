<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Meet Participant Lists</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    
    <style>
        /* --- General Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        #main-container {
            max-width: 210mm; /* A4 Width */
            margin: 20px auto;
            padding: 10px;
            box-sizing: border-box;
        }
        
        h1.page-title {
            text-align: center;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 10px;
            color: #0056b3;
        }

        /* --- Game Section --- */
        .game-section {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 25px;
            padding: 20mm; /* A4 padding */
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .game-header h2 {
            margin: 0;
            font-size: 1.8rem;
            color: #004a99;
        }

        .game-header h3 {
            margin: 5px 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .game-header p {
            margin: 5px 0 0;
            font-style: italic;
            color: #555;
            font-size: 1.1rem;
        }

        .print-btn-single {
            float: right;
            margin: -15px 0 10px 10px;
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .print-btn-single:hover {
            background-color: #0056b3;
        }

        /* --- Participant Table --- */
        .participant-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .participant-table th,
        .participant-table td {
            border: 1px solid #000; /* Solid black for print clarity */
            padding: 10px;
            text-align: left;
            vertical-align: top;
            font-size: 0.95rem;
        }

        .participant-table th {
            background-color: #e9ecef;
            color: #212529;
            font-size: 1rem;
            text-transform: uppercase;
        }

        /* Sr. No. column */
        .participant-table th:first-child,
        .participant-table td:first-child {
            text-align: center;
            width: 5%;
            font-weight: bold;
        }

        /* --- Participant Entry (Inside Cell) --- */
        .participant-entry {
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Space between grouped participants */
        }

        .participant-entry:last-child {
            margin-bottom: 0;
        }

        .participant-entry canvas {
            margin-right: 10px;
            flex-shrink: 0; /* Prevent QR from shrinking */
        }

        .participant-name {
            font-size: 1rem;
            font-weight: 500;
        }

        .no-participants {
            text-align: center;
            font-style: italic;
            color: #888;
            padding: 20px;
        }

        /* --- Print Styles --- */
        @media print {
            body {
                background-color: #ffffff;
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact; /* Force print colors in Chrome */
                print-color-adjust: exact; /* Standard */
            }

            @page {
                size: A4;
                margin: 10mm; /* Standard A4 margin */
            }

            #main-container {
                max-width: 100%;
                margin: 0;
                padding: 0;
            }
            
            h1.page-title,
            .print-btn-single {
                display: none; /* Hide global title and all print buttons */
            }

            .game-section {
                border: none;
                box-shadow: none;
                border-radius: 0;
                margin: 0;
                padding: 0;
                width: 100% !important;
                page-break-after: always; /* Each game on a new page */
            }

            .game-section:last-child {
                page-break-after: auto;
            }
            
            .participant-table {
                font-size: 10pt; /* Optimize for print density */
            }
            
            .participant-table th,
            .participant-table td {
                padding: 6px;
            }

            .participant-name {
                font-size: 0.9rem;
            }

            /* --- Logic for "Print This List" button --- */
            
            /* By default, hide all game sections when printing */
            body.printing-single .game-section {
                display: none;
            }
            
            /* Only show the section explicitly marked for printing */
            body.printing-single .game-section.show-print {
                display: block;
                page-break-after: auto; /* Don't add a page break after the single item */
            }
        }

    </style>
</head>
<body>

    <div id="main-container">
        <h1 class="page-title">Annual Sports Meet - Participant Lists</h1>
        </div>

    <script>
        // --- 1. DATA (Extended as requested) ---
        const participants = [
            // Game 1: Kho-Kho (Boys) - Team (from example)
            { "student_name": "AMAN PAREEK", "student_class": "4-A2", "student_house": "Ruby", "student_gender": "M", "game_name": "Kho-Kho (Boys)", "class_category": "3 to 4", "group_size": 11, "gender_filter": "Boys", "game_type": "Team", "participant_group_id": "team-kho-kho-boys-ruby", "access_token": "cfeda684-9989-495b-8350-2e079494d0c8" },
            { "student_name": "HITESH SHARMA", "student_class": "3-A1", "student_house": "Ruby", "student_gender": "M", "game_name": "Kho-Kho (Boys)", "class_category": "3 to 4", "group_size": 11, "gender_filter": "Boys", "game_type": "Team", "participant_group_id": "team-kho-kho-boys-ruby", "access_token": "6776aff8-1fd2-4b2c-a0c5-2966fea4ab2e" },
            { "student_name": "ROHAN MEHTA", "student_class": "4-B1", "student_house": "Sapphire", "student_gender": "M", "game_name": "Kho-Kho (Boys)", "class_category": "3 to 4", "group_size": 11, "gender_filter": "Boys", "game_type": "Team", "participant_group_id": "team-kho-kho-boys-sapphire", "access_token": "a1b2c3d4-e5f6-7890-1234-567890abcdef" },
            { "student_name": "VIVEK SINGH", "student_class": "3-C2", "student_house": "Topaz", "student_gender": "M", "game_name": "Kho-Kho (Boys)", "class_category": "3 to 4", "group_size": 11, "gender_filter": "Boys", "game_type": "Team", "participant_group_id": "team-kho-kho-boys-topaz", "access_token": "b2c3d4e5-f6a7-8901-2345-678901bcdefa" },
            { "student_name": "ARJUN JAIN", "student_class": "4-A1", "student_house": "Emerald", "student_gender": "M", "game_name": "Kho-Kho (Boys)", "class_category": "3 to 4", "group_size": 11, "gender_filter": "Boys", "game_type": "Team", "participant_group_id": "team-kho-kho-boys-emerald", "access_token": "c3d4e5f6-a7b8-9012-3456-789012cdefab" },
            
            // Game 2: Kho-Kho (Girls) - Team (Empty, from example)
            { "student_name": null, "student_class": null, "student_house": null, "student_gender": null, "game_name": "Kho-Kho (Girls)", "class_category": "3 to 4", "group_size": 11, "gender_filter": "Girls", "game_type": "Team", "participant_group_id": null, "access_token": null },

            // Game 3: 100M Race (Boys) - Individual (from example)
            { "student_name": "GARVIT JOSHI", "student_class": "3-A3", "student_house": "Sapphire", "student_gender": "M", "game_name": "100M Race (Boys)", "class_category": "3", "group_size": 1, "gender_filter": "Boys", "game_type": "Individual", "participant_group_id": "f999c2ea-22e0-4df5-a350-ee34696b2620", "access_token": "f58b81bf-c667-43f8-9428-b3a85e19839b" },
            { "student_name": "MOHIT AGARWAL", "student_class": "3-B1", "student_house": "Ruby", "student_gender": "M", "game_name": "100M Race (Boys)", "class_category": "3", "group_size": 1, "gender_filter": "Boys", "game_type": "Individual", "participant_group_id": "a123c2ea-22e0-4df5-a350-ee34696b2620", "access_token": "e47a70af-c667-43f8-9428-b3a85e19839b" },

            // Game 4: 100M Race (Girls) - Individual (Unbalanced)
            { "student_name": "PRIYA SHARMA", "student_class": "5-A1", "student_house": "Ruby", "student_gender": "F", "game_name": "100M Race (Girls)", "class_category": "5", "group_size": 1, "gender_filter": "Girls", "game_type": "Individual", "participant_group_id": "g1", "access_token": "g1-token-priya" },
            { "student_name": "ANJALI VERMA", "student_class": "5-B2", "student_house": "Ruby", "student_gender": "F", "game_name": "100M Race (Girls)", "class_category": "5", "group_size": 1, "gender_filter": "Girls", "game_type": "Individual", "participant_group_id": "g2", "access_token": "g2-token-anjali" },
            { "student_name": "SNEHA GUPTA", "student_class": "5-C1", "student_house": "Sapphire", "student_gender": "F", "game_name": "100M Race (Girls)", "class_category": "5", "group_size": 1, "gender_filter": "Girls", "game_type": "Individual", "participant_group_id": "g3", "access_token": "g3-token-sneha" },
            { "student_name": "RITU KUMARI", "student_class": "5-A2", "student_house": "Emerald", "student_gender": "F", "game_name": "100M Race (Girls)", "class_category": "5", "group_size": 1, "gender_filter": "Girls", "game_type": "Individual", "participant_group_id": "g4", "access_token": "g4-token-ritu" },
            { "student_name": "POOJA MEENA", "student_class": "5-B1", "student_house": "Sapphire", "student_gender": "F", "game_name": "100M Race (Girls)", "class_category": "5", "group_size": 1, "gender_filter": "Girls", "game_type": "Individual", "participant_group_id": "g5", "access_token": "g5-token-pooja" },
            { "student_name": "NIDHI JAIN", "student_class": "5-C2", "student_house": "Sapphire", "student_gender": "F", "game_name": "100M Race (Girls)", "class_category": "5", "group_size": 1, "gender_filter": "Girls", "game_type": "Individual", "participant_group_id": "g6", "access_token": "g6-token-nidhi" },

            // Game 5: 4x100M Relay (Boys) - Grouped
            { "student_name": "RAVI KUMAR", "student_class": "6-A1", "student_house": "Topaz", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-topaz-g1", "access_token": "r1-token-ravi" },
            { "student_name": "SANJAY BISHT", "student_class": "7-B1", "student_house": "Topaz", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-topaz-g1", "access_token": "r2-token-sanjay" },
            { "student_name": "TARUN NEGI", "student_class": "8-A2", "student_house": "Topaz", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-topaz-g1", "access_token": "r3-token-tarun" },
            { "student_name": "VARUN RAWAT", "student_class": "6-C1", "student_house": "Topaz", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-topaz-g1", "access_token": "r4-token-varun" },
            
            { "student_name": "AKASH VERMA", "student_class": "7-A3", "student_house": "Ruby", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-ruby-g1", "access_token": "r5-token-akash" },
            { "student_name": "ROHAN GUPTA", "student_class": "8-A1", "student_house": "Ruby", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-ruby-g1", "access_token": "r6-token-rohan" },
            { "student_name": "SUMIT JINDAL", "student_class": "7-B2", "student_house": "Ruby", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-ruby-g1", "access_token": "r7-token-sumit" },
            { "student_name": "KUNAL PATEL", "student_class": "6-B1", "student_house": "Ruby", "student_gender": "M", "game_name": "4x100M Relay (Boys)", "class_category": "6 to 8", "group_size": 4, "gender_filter": "Boys", "game_type": "Grouped", "participant_group_id": "relay-boys-ruby-g1", "access_token": "r8-token-kunal" },

            // Game 6: Tug of War (Mixed) - Team
            { "student_name": "DAVID WILLIAMS", "student_class": "9-A", "student_house": "Emerald", "student_gender": "M", "game_name": "Tug of War (Mixed)", "class_category": "9 to 10", "group_size": 10, "gender_filter": "Mixed", "game_type": "Team", "participant_group_id": "team-tug-mixed-emerald", "access_token": "t1-token-david" },
            { "student_name": "SARAH KHAN", "student_class": "10-B", "student_house": "Emerald", "student_gender": "F", "game_name": "Tug of War (Mixed)", "class_category": "9 to 10", "group_size": 10, "gender_filter": "Mixed", "game_type": "Team", "participant_group_id": "team-tug-mixed-emerald", "access_token": "t2-token-sarah" },
            { "student_name": "MICHAEL BROWN", "student_class": "9-C", "student_house": "Ruby", "student_gender": "M", "game_name": "Tug of War (Mixed)", "class_category": "9 to 10", "group_size": 10, "gender_filter": "Mixed", "game_type": "Team", "participant_group_id": "team-tug-mixed-ruby", "access_token": "t3-token-michael" },
            { "student_name": "JESSICA LEE", "student_class": "10-A", "student_house": "Sapphire", "student_gender": "F", "game_name": "Tug of War (Mixed)", "class_category": "9 to 10", "group_size": 10, "gender_filter": "Mixed", "game_type": "Team", "participant_group_id": "team-tug-mixed-sapphire", "access_token": "t4-token-jessica" }
        ];

        // --- 2. CONFIGURATION ---
        const qrCodeSize = 50; // Size in pixels for the QR code canvas
        const houses = ["Ruby", "Emerald", "Sapphire", "Topaz"];

        // --- 3. HELPER FUNCTIONS ---

        /**
         * Formats a single participant object into an HTML string.
         */
        function formatParticipantCell(participant) {
            if (!participant || !participant.student_name) {
                return ''; // Return empty string for blank cells
            }
            
            // Use access_token as data attribute to find canvas later
            return `
                <div class="participant-entry">
                  <canvas class="qr-canvas" data-token="${participant.access_token}"></canvas>
                  <div class="participant-name">
                    ${participant.student_name} (${participant.student_class})
                  </div>
                </div>
            `;
        }
        
        /**
         * Formats an array of participants (a group) into an HTML string.
         */
        function formatGroupCell(group) {
            if (!group || group.length === 0) {
                return ''; // Return empty string for blank cells
            }
            // Map each participant in the group to their cell format and join
            return group.map(formatParticipantCell).join('');
        }

        /**
         * Attaches a "print this list" event handler to a button.
         */
        function addPrintHandler(button) {
            button.addEventListener('click', () => {
                const sectionToPrint = button.closest('.game-section');
                
                // Add classes to body and the specific section
                document.body.classList.add('printing-single');
                sectionToPrint.classList.add('show-print');
                
                window.print(); // Trigger print dialog
            });
        }
        
        /**
         * Cleans up print-specific classes after printing is done or cancelled.
         */
        window.onafterprint = () => {
            document.body.classList.remove('printing-single');
            const printedSection = document.querySelector('.game-section.show-print');
            if (printedSection) {
                printedSection.classList.remove('show-print');
            }
        };

        // --- 4. CORE LOGIC ---

        /**
         * Main function to generate all participant lists.
         */
        function generateAllLists() {
            const container = document.getElementById('main-container');
            container.innerHTML = '<h1>... Loading Lists ...</h1>'; // Clear and show loading
            
            // Step 1: Group participants by game
            const games = {};
            for (const p of participants) {
                // Unique key for each game
                const gameKey = `${p.game_name}_${p.class_category}_${p.gender_filter}`;
                
                if (!games[gameKey]) {
                    games[gameKey] = {
                        game_name: p.game_name,
                        class_category: p.class_category,
                        gender_filter: p.gender_filter,
                        game_type: p.game_type,
                        participants: { Ruby: [], Emerald: [], Sapphire: [], Topaz: [] }
                    };
                }
                
                // Only add participants who have a name (i.e., not null)
                if (p.student_name && p.student_house) {
                    games[gameKey].participants[p.student_house].push(p);
                }
            }
            
            // Clear loading message
            container.innerHTML = '<h1 class="page-title">Annual Sports Meet - Participant Lists</h1>';

            // Step 2: Create a table for each game
            for (const game of Object.values(games)) {
                const tableHtml = createGameTable(game);
                container.insertAdjacentHTML('beforeend', tableHtml);
            }
            
            // Step 3: Add event listeners to all new print buttons
            document.querySelectorAll('.print-btn-single').forEach(addPrintHandler);

            // Step 4: Render all QR codes
            renderAllQRCodes();
        }

        /**
         * Creates the HTML string for a single game's section and table.
         */
        function createGameTable(game) {
            let tableBodyHtml = '';
            let maxRows = 0;
            let processedData = { Ruby: [], Emerald: [], Sapphire: [], Topaz: [] };
            
            if (game.game_type === 'Individual' || game.game_type === 'Team') {
                // Data is already in the right format
                processedData = game.participants;
                maxRows = Math.max(...houses.map(h => processedData[h].length));
                
            } else if (game.game_type === 'Grouped') {
                // Need to group participants by participant_group_id within each house
                for (const house of houses) {
                    const groups = {};
                    for (const p of game.participants[house]) {
                        if (!groups[p.participant_group_id]) {
                            groups[p.participant_group_id] = [];
                        }
                        groups[p.participant_group_id].push(p);
                    }
                    processedData[house] = Object.values(groups); // Now an array of arrays
                }
                maxRows = Math.max(...houses.map(h => processedData[h].length));
            }

            // Build the table rows
            if (maxRows > 0) {
                for (let i = 0; i < maxRows; i++) {
                    const rowFormatter = (game.game_type === 'Grouped') ? formatGroupCell : formatParticipantCell;
                    
                    tableBodyHtml += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${rowFormatter(processedData.Ruby[i])}</td>
                            <td>${rowFormatter(processedData.Emerald[i])}</td>
                            <td>${rowFormatter(processedData.Sapphire[i])}</td>
                            <td>${rowFormatter(processedData.Topaz[i])}</td>
                        </tr>
                    `;
                }
            } else {
                tableBodyHtml = '<tr><td colspan="5" class="no-participants">No participants registered for this event yet.</td></tr>';
            }

            // Assemble the full section HTML
            return `
                <section class="game-section">
                    <button class="print-btn-single" title="Print this list">üñ®Ô∏è Print</button>
                    <div class="game-header">
                        <h2>Jamna Vidyapeeth</h2>
                        <h3>${game.game_name}</h3>
                        <p>
                            <strong>Class Category:</strong> ${game.class_category} | 
                            <strong>Gender:</strong> ${game.gender_filter} | 
                            <strong>Type:</strong> ${game.game_type}
                        </p>
                    </div>
                    
                    <table class="participant-table">
                        <thead>
                            <tr>
                                <th>Sr. No.</th>
                                <th>Ruby</th>
                                <th>Emerald</th>
                                <th>Sapphire</th>
                                <th>Topaz</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableBodyHtml}
                        </tbody>
                    </table>
                </section>
            `;
        }
        
        /**
         * Finds all canvas elements and generates QR codes for them.
         */
        function renderAllQRCodes() {
            const canvases = document.querySelectorAll('.qr-canvas');
            
            canvases.forEach(canvas => {
                const token = canvas.dataset.token;
                if (token) {
                    QRCode.toCanvas(canvas, token, { 
                        width: qrCodeSize, 
                        margin: 1,
                        errorCorrectionLevel: 'L' // Use 'L' for smallest, dense QR
                    }, (error) => {
                        if (error) console.error("QR Code Error for token " + token, error);
                    });
                }
            });
        }

        // --- 5. INITIALIZATION ---
        // Run the main function when the document is ready
        document.addEventListener('DOMContentLoaded', generateAllLists);
        
    </script>
</body>
</html>
